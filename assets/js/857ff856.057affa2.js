"use strict";(self.webpackChunkmysite=self.webpackChunkmysite||[]).push([[7298],{37015:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>m,frontMatter:()=>l,metadata:()=>o,toc:()=>c});var t=s(13274),i=s(1780);const l={slug:"/psexec",title:"Ansible\u4f7f\u7528PsExec\u8fdc\u7a0b\u63a7\u5236Windows",authors:"gavintan",tags:["Ansible","PsExec","Windows"],description:"Ansible \u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002"},a=void 0,o={permalink:"/blog/psexec",editUrl:"https://github.com/gavintan/blog/edit/main/blog/ansible/ansible\u4f7f\u7528psexec.md",source:"@site/blog/ansible/ansible\u4f7f\u7528psexec.md",title:"Ansible\u4f7f\u7528PsExec\u8fdc\u7a0b\u63a7\u5236Windows",description:"Ansible \u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002",date:"2024-11-19T02:47:59.000Z",tags:[{label:"Ansible",permalink:"/blog/tags/ansible"},{label:"PsExec",permalink:"/blog/tags/ps-exec"},{label:"Windows",permalink:"/blog/tags/windows"}],readingTime:2.44,hasTruncateMarker:!1,authors:[{name:"GavinTan",title:"DevOps Engineer",url:"https://github.com/GavinTan",imageURL:"/img/logo.webp",key:"gavintan"}],frontMatter:{slug:"/psexec",title:"Ansible\u4f7f\u7528PsExec\u8fdc\u7a0b\u63a7\u5236Windows",authors:"gavintan",tags:["Ansible","PsExec","Windows"],description:"Ansible \u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002"},unlisted:!1,nextItem:{title:"kubernetes\u5b89\u88c5",permalink:"/blog/k8s"}},r={authorsImageUrls:[void 0]},c=[{value:"\u6982\u8981",id:"\u6982\u8981",level:2},{value:"ansible\u63a7\u5236\u7aef\u73af\u5883",id:"ansible\u63a7\u5236\u7aef\u73af\u5883",level:2},{value:"\u88ab\u63a7windows",id:"\u88ab\u63a7windows",level:2},{value:"playbook",id:"playbook",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"\u6982\u8981",children:"\u6982\u8981"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u53ef\u4ee5\u5728 Ansible \u63a7\u5236\u5668\u4e0a\u8fd0\u884c\uff0c\u4ee5\u5f15\u5bfc Windows \u4e3b\u673a\uff0c\u4f7f\u5176\u4e3a WinRM \u505a\u597d\u51c6\u5907\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://docs.ansible.com/ansible/latest/collections/community/windows/psexec_module.html",children:"\u5b98\u65b9\u6587\u6863"})}),"\n",(0,t.jsx)(n.h2,{id:"ansible\u63a7\u5236\u7aef\u73af\u5883",children:"ansible\u63a7\u5236\u7aef\u73af\u5883"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"yum install krb5-devel krb5-workstation\n\npip install pypsexec smbprotocol[kerberos]\n"})}),"\n",(0,t.jsx)(n.p,{children:"/etc/ansible/ansible.cfg"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-cfg",children:"[defaults]\n\nhost_key_checking=False\n"})}),"\n",(0,t.jsx)(n.p,{children:"/etc/ansible/hosts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[win]\n192.168.32.20\n[win:vars]\nansible_user=administrator\nansible_password=123456\nsystem=win7\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u88ab\u63a7windows",children:"\u88ab\u63a7windows"}),"\n",(0,t.jsx)(n.p,{children:"\u5fc5\u987b\u653e\u5f00445\u7aef\u53e3 \u9632\u706b\u5899\u540d\u79f0-Netlogon \u670d\u52a1(NP-In)"}),"\n",(0,t.jsx)(n.h2,{id:"playbook",children:"playbook"}),"\n",(0,t.jsx)(n.p,{children:"\u914d\u7f6ewinrm"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="config_winrm.yml"',children:"---\n- hosts: win\n  gather_facts: no\n  tasks:\n  - name: config winrm\n    local_action:\n      module: community.windows.psexec\n      hostname: '{{ hostvars[inventory_hostname][\"ansible_host\"] | default(inventory_hostname) }}'\n      connection_username: '{{ ansible_user }}'\n      connection_password: '{{ ansible_password }}'\n      encrypt: \"{{ 'false' if system == 'win7' else 'true' }}\"\n      executable: powershell.exe\n      arguments: '-'\n      stdin: |\n        #\u63d0\u524d\u8bbe\u7f6e\u7cfb\u7edf\u5bc6\u7801\uff0c\u4fee\u6539\u7f51\u7edc\u4f4d\u7f6e\u4e0d\u8981\u9009\u62e9\u516c\u7528\u7f51\u7edc\n        #\u67e5\u770bwinrm\u542f\u52a8\u72b6\u6001 winrm enumerate winrm/config/listener\n        winrm quickconfig -quiet -force\n        winrm set winrm/config/service/auth '@{Basic=\"true\"}'\n        winrm set winrm/config/service '@{AllowUnencrypted=\"true\"}'\n        exit\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u66f4\u65b0powershell\uff08ansible\u540e\u7eed\u901a\u8fc7winrm\u6216openssh\u63a7\u5236windwos\u5fc5\u987b\u5347\u7ea7\uff09"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://download.microsoft.com/download/E/4/1/E4173890-A24A-4936-9FC9-AF930FE3FA40/NDP461-KB3102436-x86-x64-AllOS-ENU.exe",children:"NDP461-KB3102436-x86-x64-AllOS-ENU.exe"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://download.microsoft.com/download/6/F/5/6F5FF66C-6775-42B0-86C4-47D41F2DA187/Win7AndW2K8R2-KB3191566-x64.zip",children:"Win7AndW2K8R2-KB3191566-x64"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="install_win32-openssh.yml"',children:'---\n- hosts: win\n  gather_facts: no\n  vars:\n    fileurl: http://192.168.8.192:8888\n  tasks:\n  - name: install .NET 4.6.1\n    register: install_net_result\n    local_action:\n      module: community.windows.psexec\n      hostname: \'{{ hostvars[inventory_hostname]["ansible_host"] | default(inventory_hostname) }}\'\n      connection_username: \'{{ ansible_user }}\'\n      connection_password: \'{{ ansible_password }}\'\n      encrypt: "{{ \'false\' if system == \'win7\' else \'true\' }}" #win7\u9700\u8981\u8bbe\u7f6efalse \u4e0d\u4f7f\u7528\u52a0\u5bc6\n      executable: powershell.exe\n      arguments: \'-\'\n      stdin: |\n        $url = "{{ fileurl }}/NDP461-KB3102436-x86-x64-AllOS-ENU.exe"\n        $file = "$env:temp\\NDP461-KB3102436-x86-x64-AllOS-ENU.exe"\n        (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\n        if (-not (Test-Path -Path $file)) {echo "download $url failed";exit 1}\n        Start-Process -FilePath $file -ArgumentList "/q /norestart" -Wait\n        exit\n  - name: install PowerShell 5.1\n    #win7\u8fdc\u7a0b\u5b89\u88c5\u66f4\u65b0\u9650\u5236 https://learn.microsoft.com/zh-cn/troubleshoot/windows-server/installing-updates-features-roles/windows-update-standalone-installer-returns-error\n    register: install_powershell_result\n    when: install_net_result.rc == 0\n    local_action:\n      module: community.windows.psexec\n      hostname: \'{{ hostvars[inventory_hostname]["ansible_host"] | default(inventory_hostname) }}\'\n      connection_username: \'{{ ansible_user }}\'\n      connection_password: \'{{ ansible_password }}\'\n      encrypt: "{{ \'false\' if system == \'win7\' else \'true\' }}"\n      executable: powershell.exe\n      arguments: \'-\'\n      stdin: |\n        $url = "{{ fileurl }}/Win7AndW2K8R2-KB3191566-x64.msu"\n        $file = "$env:temp\\Win7AndW2K8R2-KB3191566-x64.msu"\n        $extpath = "$env:temp\\Win7AndW2K8R2-KB3191566"\n        (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\n        if (-not (Test-Path -Path $file)) {echo "download $url failed";exit 1}\n        Start-Process -FilePath $file -ArgumentList "/extract:$extpath" -Wait\n        $cabfiles = Get-ChildItem -Path "$extpath" -Filter "*.cab"\n        foreach($f in $cabfiles){Start-Process -FilePath "dism.exe" -ArgumentList "/online /add-package /PackagePath:$extpath/$f /IgnoreCheck /quiet /norestart" -Wait}\n        Restart-Computer -Force\n        exit\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u5b89\u88c5openssh\uff08win10\u7cfb\u7edf\u4ee5\u4e0a\u53ef\u4ee5\u5728\u7cfb\u7edf\u8bbe\u7f6e\u529f\u80fd\u91cc\u76f4\u63a5\u542f\u7528\uff09"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win64.zip",children:"OpenSSH-Win64"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="install_win32-openssh.yml"',children:"---\n- hosts: win\n  gather_facts: no\n  vars:\n    fileurl: http://192.168.8.192:8888\n  tasks:\n  - name: download Win32-OpenSSH\n    local_action:\n      module: community.windows.psexec\n      hostname: '{{ hostvars[inventory_hostname][\"ansible_host\"] | default(inventory_hostname) }}'\n      connection_username: '{{ ansible_user }}'\n      connection_password: '{{ ansible_password }}'\n      encrypt: \"{{ 'false' if system == 'win7' else 'true' }}\"\n      executable: powershell.exe\n      arguments: '-'\n      stdin: |\n        $url = \"{{ fileurl }}/OpenSSH-Win64.zip\"\n        $file = \"$env:temp\\OpenSSH-Win64.zip\"\n        $expath = \"C:\\Program Files\"\n        (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\n        if (-not (Test-Path -Path $file)) {echo \"download $url failed\";exit 1}\n        (new-object -com shell.application).NameSpace($expath).CopyHere((new-object -com shell.application).NameSpace($file).Items())\n        exit\n  - name: install Win32-OpenSSH\n    register: install_openssh_result\n    local_action:\n      module: community.windows.psexec\n      hostname: '{{ hostvars[inventory_hostname][\"ansible_host\"] | default(inventory_hostname) }}'\n      connection_username: '{{ ansible_user }}'\n      connection_password: '{{ ansible_password }}'\n      encrypt: \"{{ 'false' if system == 'win7' else 'true' }}\"\n      interactive: true\n      executable: powershell.exe\n      arguments: '-ExecutionPolicy Bypass -File \"C:\\Program Files\\OpenSSH-Win64\\install-sshd.ps1\"'\n  - name: start Win32-OpenSSH\n    when: install_openssh_result.rc == 0\n    local_action:\n      module: community.windows.psexec\n      hostname: '{{ hostvars[inventory_hostname][\"ansible_host\"] | default(inventory_hostname) }}'\n      connection_username: '{{ ansible_user }}'\n      connection_password: '{{ ansible_password }}'\n      encrypt: \"{{ 'false' if system == 'win7' else 'true' }}\"\n      executable: powershell.exe\n      arguments: '-'\n      stdin: |\n        netsh advfirewall firewall add rule name=sshd dir=in action=allow protocol=TCP localport=22\n        net start sshd\n        Set-Service sshd -StartupType Automatic\n        exit\n  - debug:\n      var: install_openssh_result\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6253\u5f00\u8f6f\u4ef6\uff08\u8981\u5f39\u51fa\u7a97\u53e3\u5fc5\u987b\u5148\u83b7\u53d6\u5230windows\u767b\u5f55\u7528\u6237\u7684session\uff09"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="open_soft.yml"',children:"---\n- hosts: win\n  gather_facts: no\n  tasks:\n  - name: open notepad\n    local_action:\n      module: community.windows.psexec\n      hostname: '{{ hostvars[inventory_hostname][\"ansible_host\"] | default(inventory_hostname) }}'\n      connection_username: '{{ ansible_user }}'\n      connection_password: '{{ ansible_password }}'\n      encrypt: \"{{ 'false' if system == 'win7' else 'true' }}\"\n      executable: notepad.exe\n      #arguments: /c\n      working_directory: C:\\Users\\Administrator\\Desktop\n      interactive: true\n      interactive_session: 2 #\u5728windows\u4e0a\u6267\u884cqwinsta\u547d\u4ee4\u67e5\u770bsession \u6216\u8005\u6267\u884c\u547d\u4ee4query session %username%\n      process_username: system\n      asynchronous: true\n"})})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},1780:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(79474);const i={},l=t.createContext(i);function a(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);