"use strict";(self.webpackChunkmysite=self.webpackChunkmysite||[]).push([[5894],{76042:n=>{n.exports=JSON.parse('{"blogPosts":[{"id":"/psexec","metadata":{"permalink":"/blog/psexec","editUrl":"https://github.com/gavintan/blog/edit/main/blog/ansible/ansible\u4f7f\u7528psexec.md","source":"@site/blog/ansible/ansible\u4f7f\u7528psexec.md","title":"Ansible\u4f7f\u7528PsExec\u8fdc\u7a0b\u63a7\u5236Windows","description":"Ansible \u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"Ansible","permalink":"/blog/tags/ansible"},{"label":"PsExec","permalink":"/blog/tags/ps-exec"},{"label":"Windows","permalink":"/blog/tags/windows"}],"readingTime":2.44,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/psexec","title":"Ansible\u4f7f\u7528PsExec\u8fdc\u7a0b\u63a7\u5236Windows","authors":"gavintan","tags":["Ansible","PsExec","Windows"],"description":"Ansible \u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002"},"unlisted":false,"nextItem":{"title":"kubernetes\u5b89\u88c5","permalink":"/blog/k8s"}},"content":"## \u6982\u8981\\n\\n- \u65e0\u9700\u8bbe\u7f6e WinRM \u5373\u53ef\u4ece Linux \u4e3b\u673a\u5411 Windows \u4e3b\u673a\u8fd0\u884c\u8fdc\u7a0b\u547d\u4ee4\u3002\\n\\n- \u53ef\u4ee5\u5728 Ansible \u63a7\u5236\u5668\u4e0a\u8fd0\u884c\uff0c\u4ee5\u5f15\u5bfc Windows \u4e3b\u673a\uff0c\u4f7f\u5176\u4e3a WinRM \u505a\u597d\u51c6\u5907\u3002\\n\\n\\n\\n[\u5b98\u65b9\u6587\u6863](https://docs.ansible.com/ansible/latest/collections/community/windows/psexec_module.html)\\n\\n\\n\\n## ansible\u63a7\u5236\u7aef\u73af\u5883\\n\\n```shell\\nyum install krb5-devel krb5-workstation\\n\\npip install pypsexec smbprotocol[kerberos]\\n```\\n\\n\\n\\n/etc/ansible/ansible.cfg\\n\\n```cfg\\n[defaults]\\n\\nhost_key_checking=False\\n```\\n\\n\\n\\n/etc/ansible/hosts\\n\\n```\\n[win]\\n192.168.32.20\\n[win:vars]\\nansible_user=administrator\\nansible_password=123456\\nsystem=win7\\n```\\n\\n\\n\\n## \u88ab\u63a7windows\\n\\n\u5fc5\u987b\u653e\u5f00445\u7aef\u53e3 \u9632\u706b\u5899\u540d\u79f0-Netlogon \u670d\u52a1(NP-In)\\n\\n## playbook\\n\\n\u914d\u7f6ewinrm\\n\\n```yaml title=\\"config_winrm.yml\\"\\n---\\n- hosts: win\\n  gather_facts: no\\n  tasks:\\n  - name: config winrm\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\"\\n      executable: powershell.exe\\n      arguments: \'-\'\\n      stdin: |\\n        #\u63d0\u524d\u8bbe\u7f6e\u7cfb\u7edf\u5bc6\u7801\uff0c\u4fee\u6539\u7f51\u7edc\u4f4d\u7f6e\u4e0d\u8981\u9009\u62e9\u516c\u7528\u7f51\u7edc\\n        #\u67e5\u770bwinrm\u542f\u52a8\u72b6\u6001 winrm enumerate winrm/config/listener\\n        winrm quickconfig -quiet -force\\n        winrm set winrm/config/service/auth \'@{Basic=\\"true\\"}\'\\n        winrm set winrm/config/service \'@{AllowUnencrypted=\\"true\\"}\'\\n        exit\\n```\\n\\n\\n\\n\u66f4\u65b0powershell\uff08ansible\u540e\u7eed\u901a\u8fc7winrm\u6216openssh\u63a7\u5236windwos\u5fc5\u987b\u5347\u7ea7\uff09\\n\\n- [NDP461-KB3102436-x86-x64-AllOS-ENU.exe](https://download.microsoft.com/download/E/4/1/E4173890-A24A-4936-9FC9-AF930FE3FA40/NDP461-KB3102436-x86-x64-AllOS-ENU.exe)\\n- [Win7AndW2K8R2-KB3191566-x64](https://download.microsoft.com/download/6/F/5/6F5FF66C-6775-42B0-86C4-47D41F2DA187/Win7AndW2K8R2-KB3191566-x64.zip)\\n\\n```yaml title=\\"install_win32-openssh.yml\\"\\n---\\n- hosts: win\\n  gather_facts: no\\n  vars:\\n    fileurl: http://192.168.8.192:8888\\n  tasks:\\n  - name: install .NET 4.6.1\\n    register: install_net_result\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\" #win7\u9700\u8981\u8bbe\u7f6efalse \u4e0d\u4f7f\u7528\u52a0\u5bc6\\n      executable: powershell.exe\\n      arguments: \'-\'\\n      stdin: |\\n        $url = \\"{{ fileurl }}/NDP461-KB3102436-x86-x64-AllOS-ENU.exe\\"\\n        $file = \\"$env:temp\\\\NDP461-KB3102436-x86-x64-AllOS-ENU.exe\\"\\n        (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\\n        if (-not (Test-Path -Path $file)) {echo \\"download $url failed\\";exit 1}\\n        Start-Process -FilePath $file -ArgumentList \\"/q /norestart\\" -Wait\\n        exit\\n  - name: install PowerShell 5.1\\n    #win7\u8fdc\u7a0b\u5b89\u88c5\u66f4\u65b0\u9650\u5236 https://learn.microsoft.com/zh-cn/troubleshoot/windows-server/installing-updates-features-roles/windows-update-standalone-installer-returns-error\\n    register: install_powershell_result\\n    when: install_net_result.rc == 0\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\"\\n      executable: powershell.exe\\n      arguments: \'-\'\\n      stdin: |\\n        $url = \\"{{ fileurl }}/Win7AndW2K8R2-KB3191566-x64.msu\\"\\n        $file = \\"$env:temp\\\\Win7AndW2K8R2-KB3191566-x64.msu\\"\\n        $extpath = \\"$env:temp\\\\Win7AndW2K8R2-KB3191566\\"\\n        (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\\n        if (-not (Test-Path -Path $file)) {echo \\"download $url failed\\";exit 1}\\n        Start-Process -FilePath $file -ArgumentList \\"/extract:$extpath\\" -Wait\\n        $cabfiles = Get-ChildItem -Path \\"$extpath\\" -Filter \\"*.cab\\"\\n        foreach($f in $cabfiles){Start-Process -FilePath \\"dism.exe\\" -ArgumentList \\"/online /add-package /PackagePath:$extpath/$f /IgnoreCheck /quiet /norestart\\" -Wait}\\n        Restart-Computer -Force\\n        exit\\n```\\n\\n\\n\\n\\n\\n\u5b89\u88c5openssh\uff08win10\u7cfb\u7edf\u4ee5\u4e0a\u53ef\u4ee5\u5728\u7cfb\u7edf\u8bbe\u7f6e\u529f\u80fd\u91cc\u76f4\u63a5\u542f\u7528\uff09\\n\\n- [OpenSSH-Win64](https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win64.zip)\\n\\n```yaml title=\\"install_win32-openssh.yml\\"\\n---\\n- hosts: win\\n  gather_facts: no\\n  vars:\\n    fileurl: http://192.168.8.192:8888\\n  tasks:\\n  - name: download Win32-OpenSSH\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\"\\n      executable: powershell.exe\\n      arguments: \'-\'\\n      stdin: |\\n        $url = \\"{{ fileurl }}/OpenSSH-Win64.zip\\"\\n        $file = \\"$env:temp\\\\OpenSSH-Win64.zip\\"\\n        $expath = \\"C:\\\\Program Files\\"\\n        (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)\\n        if (-not (Test-Path -Path $file)) {echo \\"download $url failed\\";exit 1}\\n        (new-object -com shell.application).NameSpace($expath).CopyHere((new-object -com shell.application).NameSpace($file).Items())\\n        exit\\n  - name: install Win32-OpenSSH\\n    register: install_openssh_result\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\"\\n      interactive: true\\n      executable: powershell.exe\\n      arguments: \'-ExecutionPolicy Bypass -File \\"C:\\\\Program Files\\\\OpenSSH-Win64\\\\install-sshd.ps1\\"\'\\n  - name: start Win32-OpenSSH\\n    when: install_openssh_result.rc == 0\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\"\\n      executable: powershell.exe\\n      arguments: \'-\'\\n      stdin: |\\n        netsh advfirewall firewall add rule name=sshd dir=in action=allow protocol=TCP localport=22\\n        net start sshd\\n        Set-Service sshd -StartupType Automatic\\n        exit\\n  - debug:\\n      var: install_openssh_result\\n```\\n\\n\\n\\n\u6253\u5f00\u8f6f\u4ef6\uff08\u8981\u5f39\u51fa\u7a97\u53e3\u5fc5\u987b\u5148\u83b7\u53d6\u5230windows\u767b\u5f55\u7528\u6237\u7684session\uff09\\n\\n```yaml title=\\"open_soft.yml\\"\\n---\\n- hosts: win\\n  gather_facts: no\\n  tasks:\\n  - name: open notepad\\n    local_action:\\n      module: community.windows.psexec\\n      hostname: \'{{ hostvars[inventory_hostname][\\"ansible_host\\"] | default(inventory_hostname) }}\'\\n      connection_username: \'{{ ansible_user }}\'\\n      connection_password: \'{{ ansible_password }}\'\\n      encrypt: \\"{{ \'false\' if system == \'win7\' else \'true\' }}\\"\\n      executable: notepad.exe\\n      #arguments: /c\\n      working_directory: C:\\\\Users\\\\Administrator\\\\Desktop\\n      interactive: true\\n      interactive_session: 2 #\u5728windows\u4e0a\u6267\u884cqwinsta\u547d\u4ee4\u67e5\u770bsession \u6216\u8005\u6267\u884c\u547d\u4ee4query session %username%\\n      process_username: system\\n      asynchronous: true\\n```"},{"id":"/k8s","metadata":{"permalink":"/blog/k8s","editUrl":"https://github.com/gavintan/blog/edit/main/blog/k8s/k8s\u5b89\u88c5.mdx","source":"@site/blog/k8s/k8s\u5b89\u88c5.mdx","title":"kubernetes\u5b89\u88c5","description":"Kubernetes\uff0c\u4e5f\u88ab\u79f0\u4e3aK8s\uff0c\u662f\u4e00\u4e2a\u7528\u4e8e\u81ea\u52a8\u5316\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u5f00\u6e90\u7cfb\u7edf\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"k8s","permalink":"/blog/tags/k-8-s"},{"label":"kubernetes","permalink":"/blog/tags/kubernetes"}],"readingTime":3.9366666666666665,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/k8s","title":"kubernetes\u5b89\u88c5","authors":"gavintan","tags":["k8s","kubernetes"],"description":"Kubernetes\uff0c\u4e5f\u88ab\u79f0\u4e3aK8s\uff0c\u662f\u4e00\u4e2a\u7528\u4e8e\u81ea\u52a8\u5316\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u7684\u5f00\u6e90\u7cfb\u7edf\u3002"},"unlisted":false,"prevItem":{"title":"Ansible\u4f7f\u7528PsExec\u8fdc\u7a0b\u63a7\u5236Windows","permalink":"/blog/psexec"},"nextItem":{"title":"WinServer2022\u5b89\u88c5RDWeb HTML5\u5ba2\u6237\u7aef","permalink":"/blog/rdweb"}},"content":"import Tabs from \'@theme/Tabs\'\\nimport TabItem from \'@theme/TabItem\'\\n\\n## \u51c6\u5907\u7cfb\u7edf\u73af\u5883\\n\\n\u5173\u95ed swap\\n\\n```\\nswapoff -a\\nsed -i \'s/.*swap/#&/\' /etc/fstab\\n```\\n\\n\u4fee\u6539\u5185\u6838\u53c2\u6570\\n\\n```shell\\ncat <<EOF > /etc/sysctl.d/k8s.conf\\nnet.bridge.bridge-nf-call-ip6tables = 1\\nnet.bridge.bridge-nf-call-iptables = 1\\nnet.ipv4.ip_nonlocal_bind = 1\\nnet.ipv4.ip_forward = 1\\nvm.swappiness = 0\\nvm.max_map_count = 262144\\nnet.netfilter.nf_conntrack_max = 1000000\\nEOF\\n\\ncat <<EOF | sudo tee /etc/modules-load.d/k8s.conf\\nbr_netfilter\\nEOF\\n\\necho \\"* soft nofile 65536\\" >> /etc/security/limits.conf\\necho \\"* hard nofile 65536\\" >> /etc/security/limits.conf\\n\\nmodprobe br_netfilter\\nsysctl -p /etc/sysctl.d/k8s.conf\\n```\\n\\n## \u5b89\u88c5 docker\\n\\n<Tabs>\\n  <TabItem value=\\"\u811a\u672c\u5b89\u88c5\\" default>\\n\\n    ```shell\\n    curl -fsSL https://get.docker.com/ | sh -s -- --mirror Aliyun\\n    ```\\n\\n  </TabItem>\\n  <TabItem value=\\"yum\u5b89\u88c5\\">\\n\\n```shell\\nyum -y install yum-utils\\nyum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\\nyum -y install docker-ce\\n```\\n\\n  </TabItem>\\n\\n  <TabItem value=\\"yum\u963f\u91cc\u6e90\u5b89\u88c5\\">\\n\\n```shell\\nyum -y install yum-utils\\nyum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\\nyum -y install docker-ce\\n```\\n\\n  </TabItem>\\n\\n</Tabs>\\n\\n\u521b\u5efa docker \u914d\u7f6e\u6587\u4ef6\\n\\n```json title=\\"/etc/docker/daemon.json\\"\\n{\\n  \\"registry-mirrors\\": [\\"https://fl791z1h.mirror.aliyuncs.com\\"],\\n  \\"exec-opts\\": [\\"native.cgroupdriver=systemd\\"],\\n  \\"log-driver\\": \\"json-file\\",\\n  \\"log-opts\\": {\\n    \\"max-size\\": \\"100m\\"\\n  },\\n  \\"storage-driver\\": \\"overlay2\\"\\n}\\n```\\n\\n## \u5b89\u88c5 kubernetes\\n\\n<Tabs>\\n  <TabItem value=\\"\u5b98\u65b9\u6e90\\" default>\\n\\n```shell\\ncat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\\n[kubernetes]\\nname=Kubernetes\\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\\\$basearch\\nenabled=1\\ngpgcheck=1\\nrepo_gpgcheck=1\\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\\nexclude=kubelet kubeadm kubectl\\nEOF\\n```\\n\\n  </TabItem>\\n\\n  <TabItem value=\\"\u963f\u91cc\u6e90\\">\\n\\n```shell\\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\\n[kubernetes]\\nname=Kubernetes\\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\\nenabled=1\\ngpgcheck=1\\nrepo_gpgcheck=1\\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\\nEOF\\n```\\n\\n  </TabItem>\\n\\n</Tabs>\\n\\n1. \u5b89\u88c5\u5de5\u5177\\n\\n   ```shell\\n   yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\\n   ```\\n\\n2. \u521d\u59cb\u5316\u96c6\u7fa4\\n\\n   :::info\\n\\n   --service-cidr service ip \u8303\u56f4\\n\\n   --pod-network-cidr pod ip \u8303\u56f4\\n\\n   :::\\n\\n   > \u51fa\u73b0 tc not found in system path \u9519\u8bef\uff1a yum install -y iproute-tc\\n\\n   ```shell\\n   # \u9ad8\u53ef\u7528\u96c6\u7fa4\u4f7f\u7528\u53c2\u6570--control-plane-endpoint=mycluster:443\\n   kubeadm init --kubernetes-version=1.18.0 --apiserver-advertise-address=172.16.7.14 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.10.0.0/16 --pod-network-cidr=10.244.0.0/16\\n   ```\\n\\n3. \u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\\n\\n   <Tabs>\\n\\n   <TabItem value=\\"calico\\" default>\\n\\n   ```shell\\n   kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.4/manifests/tigera-operator.yaml\\n   kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.4/manifests/custom-resources.yaml\\n   ```\\n\\n   </TabItem>\\n\\n   <TabItem value=\\"flannel\\">\\n\\n   ```shell\\n   kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\\n   ```\\n\\n   </TabItem>\\n\\n     \\t\\t </Tabs>\\n\\n   :::tip\\n\\n   calico \u8282\u70b9\u51fa\u73b0 mster calico-node notready \u72b6\u6001\u4ee5\u53ca\u51fa\u73b0 Connect Socket: Connection reset by peer bird: BGP: Unexpected connect from unknown address\\n\\n   ```\\n   # \u4e3aCalico\u8282\u70b9\u914d\u7f6eIP\u81ea\u52a8\u68c0\u6d4b\uff0c\u4ee5\u786e\u4fdd\u4f7f\u7528\u6b63\u786e\u7684IP\u5730\u5740\u8fdb\u884c\u8def\u7531interface=\u4fee\u6539\u4e3a\u5bf9\u5e94\u7684\u5b9e\u9645\u7269\u7406\u7f51\u5361\\n   kubectl set env daemonset/calico-node -n kube-system IP_AUTODETECTION_METHOD=interface=eth.*\\n   ```\\n\\n   :::\\n\\n## \u96c6\u7fa4\u8bbe\u7f6e\\n\\n\u542f\u7528 ipvs \u6a21\u5f0f\\n\\n```shell\\n# \u4fee\u6539ConfigMap\u7684kube-system/kube-proxy\u4e2d\u7684config.conf\uff0cmode: \\"ipvs\\"\\n\\nkubectl edit cm kube-proxy -n kube-system\\n\\n# \u4fee\u6539\u540e\u91cd\u542fkube-proxy\\nkubectl rollout restart daemonset kube-proxy -n kube-system\\n```\\n\\n\u542f\u7528 vip\\n\\n:::tip\\n\\n\u591a master \u987b\u5728\u6bcf\u4e2a master \u8282\u70b9\u4e0a\u9762\u6267\u884c\\n\\n:::\\n\\n```shell\\n# \u5b9a\u4e49vip\u5730\u5740\u5fc5\u987b\u540c\u5728\u4e3b\u673a\u7f51\u7edc\u975e\u4f7f\u7528\u7684ip\\nexport VIP=172.16.7.18\\n# \u5b9a\u4e49\u7f51\u5361\u63a5\u53e3\u4e3b\u673a\u5f53\u524d\u7f51\u5361\\nexport INTERFACE=eth0\\n\\nctr image pull ghcr.io/kube-vip/kube-vip:v0.4.0\\nctr run --rm --net-host ghcr.io/kube-vip/kube-vip:v0.4.0 vip /kube-vip manifest pod \\\\\\n--interface $INTERFACE \\\\\\n--vip $VIP \\\\\\n--controlplane \\\\\\n--services \\\\\\n--arp \\\\\\n--leaderElection | tee  /etc/kubernetes/manifests/kube-vip.yaml\\n```\\n\\n## \u5b89\u88c5 storageclass\\n\\n> \u9700\u8981\u4fee\u6539 deployment.yaml \u6587\u4ef6\u91cc\u7684 nfs \u670d\u52a1\u5730\u5740\u4e0e\u8def\u5f84\\n\\n```shell\\ngit clone https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner\\ncd nfs-subdir-external-provisioner && kubectl apply -f deploy/deployment.yaml  deploy/rbac.yaml deploy/class.yaml\\n```\\n\\n\u8bbe\u7f6e nfs \u9ed8\u8ba4 sc\\n\\n```\\nkubectl patch storageclass managed-nfs-storage -p \'{\\"metadata\\": {\\"annotations\\":{\\"storageclass.kubernetes.io/is-default-class\\":\\"true\\"}}}\'\\n```\\n\\n## \u5b89\u88c5 ingress\\n\\n```shell\\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/baremetal/deploy.yaml\\n```\\n\\n\u8bbe\u7f6e\u9ed8\u8ba4 ingress \u7c7b\\n\\n```shell\\nkubectl patch ingressclass nginx -p \'{\\"metadata\\": {\\"annotations\\":{\\"ingressclass.kubernetes.io/is-default-class\\":\\"true\\"}}}\'\\n```\\n\\ningress-nginx path \u88ab\u5e26\u8fc7\u53bb ingress \u914d\u7f6e\u6dfb\u52a0\u4e0b\u9762\u914d\u7f6e\\n\\n```yaml\\nannotations:\\n  nginx.ingress.kubernetes.io/rewrite-target: /\\n```\\n\\n:::info\\n\\n\u6dfb\u52a0\u4e00\u4e2a ingress\uff08\u901a\u8fc7 ingressClassName \u53ef\u6307\u5b9a ingressclass\uff0c\u4e0d\u6307\u5b9a\u4f7f\u7528\u9ed8\u8ba4 ingressclass\uff09\\n\\n```yaml\\nkind: Ingress\\napiVersion: networking.k8s.io/v1\\nmetadata:\\n  namespace: ops\\nspec:\\n  ingressClassName: nginx\\n  rules:\\n    - host: zabbix.172.16.7.14.nip.io\\n      http:\\n        paths:\\n          - path: /\\n            pathType: ImplementationSpecific\\n            backend:\\n              service:\\n                name: zabbix-web\\n                port:\\n                  number: 8080\\n```\\n\\n:::\\n\\n## \u5b89\u88c5 kubernetes-dashboard\\n\\n```shell\\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml\\n```\\n\\n\u6388\u6743\\n\\n```shell\\nkubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --user=system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard\\n\\n#kubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --group=system:serviceaccount\\n```\\n\\n\u83b7\u53d6 token\\n\\n```shell\\nkubectl describe secrets -n kubernetes-dashboard $(kubectl -n kubernetes-dashboard get secret|grep kubernetes-dashboard-token|awk \'{print $1}\')| grep token | awk \'NR==3{print $2}\'\\n```\\n\\n\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\\n\\n```shell\\n# \u4fee\u6539service\u914d\u7f6e\uff0c\u627e\u5230type\uff0c\u5c06ClusterIP\u6539\u6210NodePort \u8bbe\u7f6enodePort\u7aef\u53e3\\nkubectl edit svc kubernetes-dashboard -n kubernetes-dashboard\\n```\\n\\n## \u5b89\u88c5 kubeshpere\\n\\n```shell\\nkubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/kubesphere-installer.yaml\\n\\n\\nkubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/cluster-configuration.yaml\\n```\\n\\n\u68c0\u67e5\u5b89\u88c5\u65e5\u5fd7\\n\\n```shell\\nkubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath=\'{.items[0].metadata.name}\') -f\\n```\\n\\n## \u5e38\u7528\u64cd\u4f5c\\n\\n\u89e6\u53d1\u6eda\u52a8\u66f4\u65b0\\n\\n```shell\\nkubectl rollout restart deploy myapp-deploy -n ops\\n\\n\\n#\u65e7\u7248\u672c\u4e0d\u652f\u6301rollout\u7684\u4fee\u6539deployment\u914d\u7f6e\u6587\u4ef6\u89e6\u53d1\u6eda\u52a8\u66f4\u65b0\\nrevision=`kubectl -n ops get deploy opsinterface-v1 -ojson|jq -r \'.metadata.annotations.\\"deployment.kubernetes.io/revision\\"|tonumber+1\'`\\nkubectl patch deployment test01-app1 -p \'{\\"spec\\":{\\"template\\": {\\"metadata\\": {\\"annotations\\": {\\"deployment.kubernetes.io/revision\\": $revision}}}}}\'\\n\\nkubectl patch deployment test01-app1 -p \'{\\"spec\\":{\\"template\\": {\\"metadata\\": {\\"annotations\\": {\\"kubectl.kubernetes.io/restartedAt\\": \\"\'`date -Iseconds`\'\\"}}}}}\'\\n```\\n\\n\u65b0\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\\n\\n```shell\\n# \u81ea\u52a8\u751f\u6210join\u547d\u4ee4\\nkubeadm token create --print-join-command\\n```\\n\\n\u5bfc\u51fa\u5f53\u524d\u96c6\u7fa4\u914d\u7f6e\\n\\n```shell\\nkubeadm config view > k8s.yaml\\n```\\n\\n\u66f4\u65b0\u8bc1\u4e66\\n\\n```shell\\nkubeadm alpha certs renew all --config=k8s.yaml\\n```\\n\\n\u4fee\u6539\u8282\u70b9 ROLES\\n\\n```shell\\nkubectl label --overwrite nodes nodename kubernetes.io/role=node1\\n```\\n\\nkubectl \u81ea\u52a8\u8865\u5168\\n\\n```shell\\necho \\"source <(kubectl completion bash)\\" >> ~/.bashrc\\n```\\n\\n## \u7591\u96be\u89e3\u7b54\\n\\n\u5361\u4f4f Terminating \u72b6\u6001\u7684\u8d44\u6e90\u65e0\u6cd5\u5220\u9664\\n\\n> \u5220\u9664\u8d44\u6e90 yml \u914d\u7f6e\u91cc\u7684 finalizers \u5185\u5bb9\u5373\u53ef\\n\\n```shell\\nkubectl patch ns/myns -p \'{\\"metadata\\":{\\"finalizers\\":[]}}\' --type=merge\\n```\\n\\netcd \u65e0\u6cd5\u542f\u52a8\uff08\u8282\u70b9\u6302\u6389\uff09\\n\\n> --force-new-cluster \u6dfb\u52a0\u8be5\u53c2\u6570\u8986\u76d6\u65e7\u96c6\u7fa4\u4fe1\u606f\uff0c\u6b63\u5e38\u542f\u52a8\u540e\u53ef\u53bb\u6389\\n\\n```shell\\nvim /etc/kubernetes/manifests/etcd.yaml\\n\\n# \u67e5\u770betcd\u96c6\u7fa4\u4fe1\u606f\\netcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key endpoint status --cluster -w table\\n```\\n\\n\u5220\u9664\u6240\u6709 Evicted Pod\\n\\n```shell\\nkubectl get pods --all-namespaces -o json | jq \'.items[] | select(.status.reason!=null) | select(.status.reason | contains(\\"Evicted\\")) | \\"kubectl delete pods \\\\(.metadata.name) -n \\\\(.metadata.namespace)\\"\' | xargs -n 1 bash -c\\n```\\n\\n\u4fee\u590d/etc/kubernetes \u6240\u6709\u6587\u4ef6\\n\\n1. \u751f\u6210\u96c6\u7fa4\u914d\u7f6e\u6587\u4ef6\\n\\n   ```shell\\n   kubeadm init phase certs all --config k8s.yml\\n   kubeadm init phase kubeconfig all --config k8s.yml\\n   kubeadm init phase control-plane all --config k8s.yml\\n   kubeadm init phase etcd local --config k8s.yml\\n   ```\\n\\n2. \u66f4\u65b0 cluster-info \u914d\u7f6e\\n\\n   ```shell\\n   kubeadm init phase bootstrap-token\\n   ```\\n\\n3. \u91cd\u542f\u63a7\u5236\u5e73\u9762\u7ec4\u4ef6\\n\\n   ```shell\\n   docker ps |grep -E \'k8s_kube-apiserver|k8s_kube-controller-manager|k8s_kube-scheduler|k8s_etcd_etcd\' | awk  \'{print $1}\'|xargs docker restart\\n   ```\\n\\n4. \u4fee\u590d kubelet \u914d\u7f6e\\n\\n   ```shell\\n   systemctl stop kubelet\\n   rm -rf /var/lib/kubelet/pki/ /etc/kubernetes/kubelet.conf\\n   kubeadm init phase kubeconfig kubelet --config k8s.yml\\n   kubeadm init phase kubelet-start --config k8s.yml\\n   ```"},{"id":"/rdweb","metadata":{"permalink":"/blog/rdweb","editUrl":"https://github.com/gavintan/blog/edit/main/blog/win\u670d\u52a1\u5668/rdweb.md","source":"@site/blog/win\u670d\u52a1\u5668/rdweb.md","title":"WinServer2022\u5b89\u88c5RDWeb HTML5\u5ba2\u6237\u7aef","description":"RDWeb HTML5\u5ba2\u6237\u7aef\u53ef\u4ee5\u76f4\u63a5\u5728web\u91cc\u8bbf\u95eeRemoteApp\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"RD","permalink":"/blog/tags/rd"},{"label":"RDWeb","permalink":"/blog/tags/rd-web"},{"label":"RDWeb HTML5","permalink":"/blog/tags/rd-web-html-5"},{"label":"Windows Server 2022","permalink":"/blog/tags/windows-server-2022"}],"readingTime":1.7133333333333334,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/rdweb","title":"WinServer2022\u5b89\u88c5RDWeb HTML5\u5ba2\u6237\u7aef","authors":"gavintan","tags":["RD","RDWeb","RDWeb HTML5","Windows Server 2022"],"description":"RDWeb HTML5\u5ba2\u6237\u7aef\u53ef\u4ee5\u76f4\u63a5\u5728web\u91cc\u8bbf\u95eeRemoteApp\u3002","image":"https://raw.githubusercontent.com/GavinTan/files/master/picgo/image-20231020163129119.png"},"unlisted":false,"prevItem":{"title":"kubernetes\u5b89\u88c5","permalink":"/blog/k8s"},"nextItem":{"title":"hadoop\u5b89\u88c5","permalink":"/blog/hadoop"}},"content":"## \u5b89\u88c5Remote Desktop Services\\n\\n1. \u5b89\u88c5Active Directory\u57df\u670d\u52a1\\n\\n   ![image-20231012171310650](https://raw.githubusercontent.com/GavinTan/files/master/picgo/image-20231012171310650.png)\\n\\n2. \u5b89\u88c5\uff1a\u6dfb\u52a0\u89d2\u8272\u548c\u529f\u80fd\u5411\u5bfc--\x3e\u8fdc\u7a0b\u684c\u9762\u670d\u52a1\u5b89\u88c5--\x3e\u5feb\u901f\u542f\u52a8--\x3e\u57fa\u4e8e\u4f1a\u8bdd\u7684\u684c\u9762\u90e8\u7f72\\n\\n   ![image-20231017161014879](https://raw.githubusercontent.com/GavinTan/files/master/picgo/image-20231017161014879.png)\\n\\n3. \u914d\u7f6e\uff1a\u670d\u52a1\u5668\u7ba1\u7406\u5668--\x3e\u8fdc\u7a0b\u684c\u9762\u670d\u52a1\\n\\n   \u70b9\u51fb\u6982\u8ff0\u91cc\u7eff\u8272\u7684RD \u7f51\u5173 + RD \u6388\u6743\u8fdb\u884c\u914d\u7f6e\\n\\n   > RD\u7f51\u5173\u81ea\u7b7e\u8bc1\u4e66\u540d\u79f0\u914d\u7f6e\u81ea\u5df1\u57df\u540d\u548c\u81ea\u5b9a\u4e49\u5176\u4ed6\u57df\u540d\u90fd\u53ef\\n\\n   ![image-20231020163129119](https://raw.githubusercontent.com/GavinTan/files/master/picgo/image-20231020163129119.png)\\n\\n   \\n\\n   \u70b9\u51fb\u6982\u8ff0\u91cc\u7684\u90e8\u7f72\u6982\u8ff0\u4efb\u52a1\u4e0b\u62c9\u9009\u9879--\x3e\u7f16\u8f91\u90e8\u7f72\u5c5e\u6027--\x3e\u8bc1\u4e66\uff08\u4f7f\u7528\u81ea\u5df1\u8bc1\u4e66\u6216\u662f\u76f4\u63a5\u70b9\u51fb\u521b\u5efa\u65b0\u8bc1\u4e66\uff09\\n\\n   > \u7ba1\u7406\u8bc1\u4e66\u91cc\u9762\u9009\u62e9\u73b0\u6709\u8bc1\u4e66\u5982\u679c\u51fa\u73b0 \\"\u65e0\u6cd5\u5728\u4e00\u4e2a\u6216\u591a\u4e2a\u670d\u52a1\u5668\u4e0a\u914d\u7f6e\u8be5\u8bc1\u4e66\\" \u9519\u8bef\uff0c\u9700\u8981\u53cc\u51fbpfx\u8bc1\u4e66\u5bfc\u5165\u5b58\u50a8\u4f4d\u7f6e\u8981\u9009\u62e9\u672c\u5730\u8ba1\u7b97\u673a\u3002\\n   >\\n   > \u5bfc\u51fapfx\u8bc1\u4e66\uff1a\\n   > openssl pkcs12 -export -out twss.pfx -inkey /etc/pki/ssl/twss.tk.key -in /etc/pki/ssl/twss.tk.crt\\n\\n   ![image-20231020163810060](https://raw.githubusercontent.com/GavinTan/files/master/picgo/image-20231020163810060.png)\\n\\n4. \u8bbf\u95ee\uff1ahttps://server_FQDN/RDWeb/webclient/index.html\\n\\n\\n\\n`remoteApp \u522b\u540d\u4e2d\u6587\u4f1a\u51fa\u73b0\\"String has UTF-16 code units that do not fit in 8 bits\\"\u9519\u8bef\u5bfc\u81f4\u9ed1\u5c4f\uff08\u9ed8\u8ba4\u9009\u7528\u5feb\u901f\u542f\u52a8\u521b\u5efa\u7684\u793a\u4f8b\u7684remoteApp\u4f1a\u662f\u4e2d\u6587\u522b\u540d\uff09`\\n\\n\\n\\n\\n\\n## \u5b89\u88c5RD WEB HTML5\u5ba2\u6237\u7aef\\n\\n[\u67e5\u770b\u5b98\u65b9\u5b89\u88c5\u6587\u6863](https://learn.microsoft.com/zh-cn/windows-server/remote/remote-desktop-services/clients/remote-desktop-web-client-admin)\\n\\n1. \u66f4\u65b0 PowerShellGet \u6a21\u5757\\n\\n   ```powershell\\n   Install-Module -Name PowerShellGet -Force\\n   ```\\n\\n   \\n\\n2. \u4f7f\u7528\u6b64 cmdlet \u4ece PowerShell \u5e93\u5b89\u88c5\u8fdc\u7a0b\u684c\u9762 Web \u5ba2\u6237\u7aef\u7ba1\u7406 PowerShell \u6a21\u5757\\n\\n   > \u4e0a\u9762\u66f4\u65b0\u6a21\u5757\u540e\u9700\u8981\u5148\u91cd\u542f PowerShell\uff0c\u7136\u540e\u66f4\u65b0\u624d\u80fd\u751f\u6548\uff0c\u5426\u5219\u6a21\u5757\u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\u3002\\n\\n   ```powershell\\n   Install-Module -Name RDWebClientManagement\\n   ```\\n\\n   \\n\\n3. \u4e0b\u8f7d\u8fdc\u7a0b\u684c\u9762 Web \u5ba2\u6237\u7aef\u7684\u6700\u65b0\u7248\u672c\uff1a\\n\\n   ```powershell\\n   Install-RDWebClientPackage\\n   ```\\n\\n   \\n\\n4. \u5bfc\u5165ssl\u8bc1\u4e66[.cer \u6216 .crt \u6587\u4ef6\u7684\u8def\u5f84]\\n\\n   >\u53ef\u4ee5\u5728certmgr.msc\u4e2a\u4eba\u8bc1\u4e66\u91cc\u5bfc\u51fa\\n\\n   ```powershell\\n   Import-RDWebClientBrokerCert [.cer file path]\\n   ```\\n\\n   \\n\\n5. \u53d1\u5e03\u8fdc\u7a0b\u684c\u9762 Web \u5ba2\u6237\u7aef\\n\\n   > \u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e2a\u8b66\u544a\uff0c\u6307\u51fa\u4e0d\u652f\u6301\u6bcf\u8bbe\u5907 CAL\uff0c\u5373\u4f7f\u662f\u9488\u5bf9\u6bcf\u7528\u6237 CAL \u914d\u7f6e\u90e8\u7f72\u4e5f\u662f\u5982\u6b64\u3002 \u5982\u679c\u90e8\u7f72\u4f7f\u7528\u6bcf\u7528\u6237 CAL\uff0c\u5219\u53ef\u4ee5\u5ffd\u7565\u6b64\u8b66\u544a\u3002 \u6211\u4eec\u663e\u793a\u5b83\u662f\u4e3a\u4e86\u786e\u4fdd\u4f60\u4e86\u89e3\u914d\u7f6e\u9650\u5236\u3002\\n\\n   ```powershell\\n   Publish-RDWebClientPackage -Type Production -Latest\\n   ```\\n\\n   \u5ba2\u6237\u7aef\u8bbf\u95ee\u5730\u5740https://server_FQDN/RDWeb/webclient/index.html\\n\\n\\n\\n\\n\\n\\n\\n\u5378\u8f7d\uff1a\\n\\n```powershell\\nUninstall-RDWebClient\\n\\nUninstall-Module -Name RDWebClientManagement\\n```"},{"id":"/hadoop","metadata":{"permalink":"/blog/hadoop","editUrl":"https://github.com/gavintan/blog/edit/main/blog/\u5927\u6570\u636e/hadoop\u5b89\u88c5.mdx","source":"@site/blog/\u5927\u6570\u636e/hadoop\u5b89\u88c5.mdx","title":"hadoop\u5b89\u88c5","description":"Apache Hadoop \u662f\u4e00\u79cd\u5f00\u6e90\u6846\u67b6\uff0c\u7528\u4e8e\u9ad8\u6548\u5b58\u50a8\u548c\u5904\u7406\u4ece GB \u7ea7\u5230 PB \u7ea7\u7684\u5927\u578b\u6570\u636e\u96c6\u3002\u5229\u7528 Hadoop\uff0c\u60a8\u53ef\u4ee5\u5c06\u591a\u53f0\u8ba1\u7b97\u673a\u7ec4\u6210\u96c6\u7fa4\u4ee5\u4fbf\u66f4\u5feb\u5730\u5e76\u884c\u5206\u6790\u6d77\u91cf\u6570\u636e\u96c6\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u4e00\u53f0\u5927\u578b\u8ba1\u7b97\u673a\u6765\u5b58\u50a8\u548c\u5904\u7406\u6570\u636e\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"bigdata","permalink":"/blog/tags/bigdata"},{"label":"hadoop","permalink":"/blog/tags/hadoop"},{"label":"Apache Hadoop","permalink":"/blog/tags/apache-hadoop"}],"readingTime":3.953333333333333,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/hadoop","title":"hadoop\u5b89\u88c5","authors":"gavintan","tags":["bigdata","hadoop","Apache Hadoop"],"description":"Apache Hadoop \u662f\u4e00\u79cd\u5f00\u6e90\u6846\u67b6\uff0c\u7528\u4e8e\u9ad8\u6548\u5b58\u50a8\u548c\u5904\u7406\u4ece GB \u7ea7\u5230 PB \u7ea7\u7684\u5927\u578b\u6570\u636e\u96c6\u3002\u5229\u7528 Hadoop\uff0c\u60a8\u53ef\u4ee5\u5c06\u591a\u53f0\u8ba1\u7b97\u673a\u7ec4\u6210\u96c6\u7fa4\u4ee5\u4fbf\u66f4\u5feb\u5730\u5e76\u884c\u5206\u6790\u6d77\u91cf\u6570\u636e\u96c6\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u4e00\u53f0\u5927\u578b\u8ba1\u7b97\u673a\u6765\u5b58\u50a8\u548c\u5904\u7406\u6570\u636e\u3002"},"unlisted":false,"prevItem":{"title":"WinServer2022\u5b89\u88c5RDWeb HTML5\u5ba2\u6237\u7aef","permalink":"/blog/rdweb"},"nextItem":{"title":"snort3\u5b89\u88c5","permalink":"/blog/snort3"}},"content":"## zookeeper \u96c6\u7fa4\\n\\n```cfg title=\\"zoo.cfg\\"\\n# The number of milliseconds of each tick\\ntickTime=2000\\n# The number of ticks that the initial \\n# synchronization phase can take\\ninitLimit=10\\n# The number of ticks that can pass between \\n# sending a request and getting an acknowledgement\\nsyncLimit=5\\n# the directory where the snapshot is stored.\\n# do not use /tmp for storage, /tmp here is just \\n# example sakes.\\ndataDir=/data/zookeeper\\n# the port at which the clients will connect\\nclientPort=2181\\n# the maximum number of client connections.\\n# increase this if you need to handle more clients\\n#maxClientCnxns=60\\n#\\n# Be sure to read the maintenance section of the \\n# administrator guide before turning on autopurge.\\n#\\n# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance\\n#\\n# The number of snapshots to retain in dataDir\\n#autopurge.snapRetainCount=3\\n# Purge task interval in hours\\n# Set to \\"0\\" to disable auto purge feature\\n#autopurge.purgeInterval=1\\n\\n## Metrics Providers\\n#\\n# https://prometheus.io Metrics Exporter\\n#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider\\n#metricsProvider.httpPort=7000\\n#metricsProvider.exportJvmInfo=true\\n#\u5f53\u524d\u8282\u70b9\u914d\u7f6e0.0.0.0\\nserver.1=0.0.0.0:2888:3888\\nserver.2=172.16.7.15:2888:3888\\nserver.3=172.16.7.16:2888:3888\\n```\\n\\n\u521b\u5efamyid\u4e0eserver.\u540e\u9762\u7684\u6807\u8bc6\u5bf9\u5e94\\n\\n```shell\\necho 1 > /data/zookeeper/myid\\n```\\n\\n\\n\\n\\n\\n## hadoop ha\u96c6\u7fa4\\n\\n\u914d\u7f6e\u6587\u4ef6\\n\\n```xml title=\\"peicore-site.xml\\"\\n<configuration>\\n    <property>\\n        <name>fs.defaultFS</name>\\n        <value>hdfs://mycluster</value>\\n        <description>namenode\u5730\u5740\uff0c\u914d\u7f6eha\u540e\u5e94\u914d\u7f6e\u6210ha nameservice\u540d\u79f0</description>\\n    </property>\\n    <property>\\n        <name>hadoop.tmp.dir</name>\\n        <value>/data/hadoop</value>\\n        <description>hadoop\u6587\u4ef6\u5b58\u653e\u8def\u5f84\u7684\u6839\u76ee\u5f55\uff0cnn dn\u9ed8\u8ba4\u4f1a\u5b58\u50a8\u5728\u8be5\u4f4d\u7f6e</description>\\n    </property>\\n    <property>\\n         <name>io.file.buffer.size</name>\\n         <value>131072</value>\\n        <description>\u5728\u5e8f\u5217\u4e2d\u4f7f\u7528\u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff0c\u4ee5byte\u4e3a\u5355\u4f4d\uff0c\u9ed8\u8ba4\u503c\u662f4KB</description>\\n    </property>\\n    <property>\\n         <name>hadoop.http.staticuser.user</name>\\n         <value>bigdata</value>\\n        <description>\u5728\u7f51\u9875\u754c\u9762\u8bbf\u95eehdfs\u4f7f\u7528\u7684\u7528\u6237\u540d\uff0c\u914d\u7f6e\u4e0e\u542f\u52a8hadoop\u540c\u6837\u7528\u6237\u624d\u6709\u6743\u9650\u8bbf\u95eehdfs</description>\\n    </property>\\n    <property>\\n        <name>ha.zookeeper.quorum</name>\\n        <value>172.16.7.14:2181,172.16.7.15:2181,172.16.7.16:2181</value>\\n        <description>\u914d\u7f6ezookeeper\u96c6\u7fa4\u5730\u5740</description>\\n    </property>\\n</configuration>\\n```\\n\\n\\n\\n```xml title=\\"hdfs-site.xml\\"\\n<configuration>\\n    <property>\\n        <name>dfs.replication</name>\\n        <value>3</value>\\n        <description>\u526f\u672c\u6570\uff0cHDFS\u5b58\u50a8\u65f6\u7684\u5907\u4efd\u6570\u91cf</description>\\n    </property>\\n    <property>\\n        <name>dfs.nameservices</name>\\n        <value>mycluster</value>\\n        <description>\u914d\u7f6eha nameservice\u540d\u79f0</description>\\n    </property>\\n    <property>\\n        <name>dfs.ha.namenodes.mycluster</name>\\n        <value>nn1,nn2</value>\\n        <description>\u8bbe\u7f6eNameNode ID\u5217\u8868\u8fdb\u884c</description>\\n    </property>\\n    <property>\\n        <name>dfs.namenode.rpc-address.mycluster.nn1</name>\\n        <value>172.16.7.14:8020</value>\\n        <description>\u8bbe\u7f6enn1\u7684NameNode\u8fdb\u7a0b\u7684\u5730\u5740\u548cIPC\u7aef\u53e3</description>\\n    </property>\\n    <property>\\n        <name>dfs.namenode.rpc-address.mycluster.nn2</name>\\n        <value>172.16.7.15:8020</value>\\n        <description>\u8bbe\u7f6enn2\u7684NameNode\u8fdb\u7a0b\u7684\u5730\u5740\u548cIPC\u7aef\u53e3</description>\\n    </property>\\n    <property>\\n        <name>dfs.namenode.http-address.mycluster.nn1</name>\\n        <value>172.16.7.14:9870</value>\\n        <description>\u8bbe\u7f6enn1\u7684NameNode\u7684web ui\u5730\u5740</description>\\n    </property>\\n    <property>\\n        <name>dfs.namenode.http-address.mycluster.nn2</name>\\n        <value>172.16.7.15:9870</value>\\n        <description>\u8bbe\u7f6enn2\u7684NameNode\u7684web ui\u5730\u5740</description>\\n    </property>\\n    <property>\\n        <name>dfs.namenode.shared.edits.dir</name>\\n        <value>qjournal://172.16.7.14:8485;172.16.7.15:8485/mycluster</value>\\n        <description>\u6307\u5b9aNameNode\u7684\u5143\u6570\u636e\u5728JournalNode\u4e0a\u7684\u5b58\u653e\u4f4d\u7f6e</description>\\n    </property>\\n    <property>\\n        <name>dfs.journalnode.edits.dir</name>\\n        <value>/data/hadoop/journaldata</value>\\n        <description>\u6307\u5b9aJournalNode\u5728\u672c\u5730\u78c1\u76d8\u5b58\u653e\u6570\u636e\u7684\u4f4d\u7f6e</description>\\n    </property>\\n    <property>\\n        <name>dfs.ha.automatic-failover.enabled</name>\\n        <value>true</value>\\n        <description>\u5f00\u542fNameNode\u81ea\u52a8\u6545\u969c\u8f6c\u79fb</description>\\n    </property>\\n    <property>\\n        <name>dfs.client.failover.proxy.provider.mycluster</name>\\n        <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value>\\n        <description>\u914d\u7f6e\u6545\u969c\u8f6c\u79fb\u4ee3\u7406\u7c7b</description>\\n    </property>\\n    <property>\\n      <name>dfs.ha.fencing.methods</name>\\n      <value>sshfence</value>\\n      <description>\u9694\u79bb\u65b9\u6cd5\u6545\u969c\u8f6c\u79fb\u671f\u95f4\u7528\u6765\u9694\u79bbActive NameNode\uff0csshfence-SSH\u5230Active NameNode\u4f7f\u7528fuser\u7ec8\u6b62\u8fdb\u7a0b\u9632\u6b62\u5b58\u5728\u591a\u4e2aActive NameNode</description>\\n    </property>\\n    <property>\\n      <name>dfs.ha.fencing.ssh.private-key-files</name>\\n      <value>/home/bigdata/.ssh/id_rsa</value>\\n      <description>\u4f7f\u7528sshfence\u9694\u79bb\u673a\u5236\u65f6\u5fc5\u987bssh\u514d\u5bc6\u767b\u9646\uff0c\u914d\u7f6eSSH\u79c1\u94a5\u6587\u4ef6</description>\\n    </property>\\n    <property>\\n      <name>dfs.ha.fencing.ssh.connect-timeout</name>\\n      <value>30000</value>\\n      <description>sshfence\u9694\u79bb\u65b9\u6cd5\u8d85\u65f6\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d</description>\\n    </property>\\n</configuration>\\n```\\n\\n\\n\\n```xml title=\\"mapred-site.xml\\"\\n<configuration>\\n    <property>\\n        <name>mapreduce.framework.name</name>\\n        <value>yarn</value>\\n\\t\\t<description>\u7528\u4e8e\u6267\u884cMapReduce\u4f5c\u4e1a\u7684\u8fd0\u884c\u65f6\u6846\u67b6\u9ed8\u8ba4local</description>\\n    </property>\\n    <property>\\n        <name>mapreduce.admin.user.env</name>\\n        <value>HADOOP_MAPRED_HOME=$HADOOP_HOME</value>\\n        <description>\u53ef\u4ee5\u8bbe\u7f6eAM\u3010AppMaster\u3011\u7aef\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5982\u679c\u4e0a\u9762\u7f3a\u5c11\u914d\u7f6e\uff0c\u53ef\u80fd\u4f1a\u9020\u6210mapreduce\u5931\u8d25</description>\\n   </property>\\n   <property>\\n        <name>yarn.app.mapreduce.am.env</name>\\n        <value>HADOOP_MAPRED_HOME=$HADOOP_HOME</value>\\n        <description>\u53ef\u4ee5\u8bbe\u7f6eAM\u3010AppMaster\u3011\u7aef\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5982\u679c\u4e0a\u9762\u7f3a\u5c11\u914d\u7f6e\uff0c\u53ef\u80fd\u4f1a\u9020\u6210mapreduce\u5931\u8d25</description>\\n   </property>\\n\\n</configuration>\\n```\\n\\n\\n\\n```xml title=\\"yarn-site.xml\\"\\n<configuration>\\n\\n\x3c!-- Site specific YARN configuration properties --\x3e\\n    <property>\\n        <name>yarn.nodemanager.aux-services</name>\\n        <value>mapreduce_shuffle</value>\\n        <description>\u81ea\u5b9a\u4e49\u670d\u52a1\u914d\u7f6eMapReduce\u8fd0\u884c\u987b\u914d\u7f6e\u6210mapreduce_shuffle</description>\\n    </property>\\n    <property>\\n        <name>yarn.resourcemanager.hostname</name>\\n        <value>master</value>\\n        <description>ResourceManager\u7684\u4e3b\u673a\u540d</description>\\n    </property>\\n    <property>\\n        <name>yarn.resourcemanager.webapp.address</name>\\n        <value>172.16.7.14:8088</value>\\n        <description>yarn web ui\u5730\u5740</description>\\n    </property>\\n    <property>\\n        <name>yarn.log-aggregation-enable</name>\\n        <value>true</value>\\n        <description>\u542f\u7528\u65e5\u5fd7\u805a\u5408\u529f\u80fd\uff0c\u65e5\u5fd7\u805a\u5408\u5f00\u542f\u540e\u4fdd\u5b58\u5230HDFS\u4e0a</description>\\n    </property>\\n    <property>\\n        <name>yarn.log-aggregation.retain-seconds</name>\\n        <value>86400</value>\\n        <description>\u805a\u5408\u540e\u7684\u65e5\u5fd7\u5728HDFS\u4e0a\u4fdd\u5b58\u65f6\u95f4</description>\\n    </property>\\n    <property>\\n        <name>yarn.log.server.url</name>\\n        <value>http://172.16.7.14:19888/jobhistory/logs</value>\\n        <description>\u65e5\u5fd7\u805a\u5408\u670d\u52a1\u5668\u7684URL</description>\\n    </property>\\n    <property>\\n        <name>yarn.nodemanager.remote-app-log-dir</name>\\n        <value>/tmp/logs</value>\\n        <description>\u65e5\u5fd7\u5728HDFS\u4e0a\u5b58\u50a8\u8def\u5f84</description>\\n    </property>\\n</configuration>\\n```\\n\\n\u914d\u7f6e\u5de5\u4eba\u8282\u70b9DataNode\u548cNodeManager\\n\\n```shell\\nvim /etc/hadoop/workers\\n172.16.7.15\\n172.16.7.16\\n```\\n\\n\u542f\u52a8\\n\\n```shell\\n#\u542f\u52a8zookeeper\u96c6\u7fa4\uff0c\u5728\u6240\u6709zookeeper\u8282\u70b9\u4e0a\u6267\u884c\\n./bin/zkServer.sh start\\n\\n#\u542f\u52a8jurnalnode\u8fdb\u7a0b\uff0c\u5728\u914d\u7f6e\u7684\u6240\u6709namenode\u8282\u70b9\u6267\u884c\\n./bin/hdfs --daemon start journalnode\\n\\n#\u683c\u5f0f\u5316namenode\uff0c\u5728\u914d\u7f6e\u7684namenode\u5176\u4e2d\u4efb\u610f\u4e00\u53f0\u4e0a\u6267\u884c\uff0c\u4ec5\u9700\u8981\u7b2c\u4e00\u6b21\u542f\u52a8\u96c6\u7fa4\u6267\u884c\\n./bin/hdfs namenode -format\\n./bin/hdfs --daemon start namenode\\n\\n#\u540c\u6b65namenode\u5143\u6570\u636e\uff0c\u5728\u672a\u6267\u884c\u683c\u5f0f\u5316\u7684\u5176\u4ed6namenode\u8282\u70b9\u4e0a\u6267\u884c\\n./bin/hdfs namenode -bootstrapStandby\\n\\n#\u542f\u52a8MR\u5386\u53f2\u8bb0\u5f55\\n./bin/mapred --daemon start historyserver\\n\\n#\u5728ZooKeeper\u4e2d\u521d\u59cb\u5316HA\u72b6\u6001\uff0c\u5728\u914d\u7f6e\u7684namenode\u5176\u4e2d\u4efb\u610f\u4e00\u53f0\u4e0a\u6267\u884c\\n./bin/hdfs zkfc -formatZK\\n\\n#\u542f\u52a8zkfc\\n./bin/hdfs --daemon start zkfc\\n\\n#\u542f\u52a8\u6240\u6709\u670d\u52a1\\n./sbin/start-all.sh\\n```\\n\\n\u5e38\u7528\u64cd\u4f5c\\n\\n```shell\\n#\u67e5\u770b\u96c6\u7fa4\u72b6\u6001\\n./bin/hadoop dfsadmin -report\\n\\n#\u505c\u6389namenode\\n./bin/hdfs --daemon stop namenode\\n\\n#\u6267\u884cwordcount\u4f8b\u5b50\\n./bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-3.2.1.jar wordcount /input /output\\n```\\n\\n\\n\\n\\n\\n## ambari\u90e8\u7f72\uff08\u7ba1\u7406\u76d1\u63a7hadoop\uff09\\n\\n\u7f16\u8bd1\\n\\n```shell\\nyum install maven rpm-build\\n\\nwget https://www-eu.apache.org/dist/ambari/ambari-2.7.5/apache-ambari-2.7.5-src.tar.gz\\ntar xfvz apache-ambari-2.7.5-src.tar.gz\\ncd apache-ambari-2.7.5-src\\nmvn versions:set -DnewVersion=2.7.5.0.0\\n \\npushd ambari-metrics\\nmvn versions:set -DnewVersion=2.7.5.0.0\\npopd\\n\\n#RHEL (CentOS 7) & SUSE (SLES 12 SP2 & SP3)\\nmvn -B clean install rpm:rpm -DnewVersion=2.7.5.0.0 -DbuildNumber=5895e4ed6b30a2da8a90fee2403b6cab91d19972 -DskipTests -Dpython.ver=\\"python >= 2.6\\" -Drat.skip=true\\n\\n#Ubuntu/Debian\\nmvn -B clean install jdeb:jdeb -DnewVersion=2.7.5.0.0 -DbuildNumber=5895e4ed6b30a2da8a90fee2403b6cab91d19972 -DskipTests -Dpython.ver=\\"python >= 2.6\\" -Drat.skip=true\\n```\\n\\n\u5b89\u88c5\\n\\n```shell\\n#RHEL (CentOS 7) & SUSE (SLES 12 SP2 & SP3)\\nyum install ambari-server/target/rpm/ambari-server/RPMS/noarch/ambari-server*.rpm \\n\\nyum install ambari-agent/target/rpm/ambari-agent/RPMS/x86_64/ambari-agent*.rpm\\n\\n#Ubuntu/Debian\\napt-get install ambari-server/target/rpm/ambari-server/RPMS/noarch/ambari-server*.deb\\n\\napt-get install ambari-agent/target/rpm/ambari-agent/RPMS/x86_64/ambari-agent*.deb\\n```\\n\\n\u542f\u52a8\u8fd0\u884c\\n\\n```shell\\nambari-server setup\\n\\nambari-server start\\nambari-agent start\\n```\\n\\n\u8bbf\u95ee\\n\\n```\\nhttp://<ambari-server-host>:8080   admin/admin\\n```\\n\\n:::tip\\n\\nbower error Unexpected token \\n[ERROR] Failed to execute goal org.codehaus.mojo:exec-maven-plugin:1.2.1:exec (Bower install) on project ambari-admin: Command execution failed. Process exited with an error: 1 (Exit value: 1) -> [Help 1]\\n\\n```shell\\nvi ambari-admin/pom.xml\\n<argument>${basedir}/src/main/resources/ui/admin-web/node_modules/bower/bin/bower</argument>\\n\u6539\u4e3a\\n<argument>bower</argument>\\n```\\n\\n:::"},{"id":"/snort3","metadata":{"permalink":"/blog/snort3","editUrl":"https://github.com/gavintan/blog/edit/main/blog/\u5b89\u5168/snort3.md","source":"@site/blog/\u5b89\u5168/snort3.md","title":"snort3\u5b89\u88c5","description":"Snort3 \u4e0b\u4e00\u4ee3Snort IPS\uff08\u5165\u4fb5\u9632\u5fa1\u7cfb\u7edf\uff09\uff0cSnort IPS \u4f7f\u7528\u4e00\u7cfb\u5217\u89c4\u5219\u6765\u5e2e\u52a9\u5b9a\u4e49\u6076\u610f\u7f51\u7edc\u6d3b\u52a8\uff0c\u5e76\u4f7f\u7528\u8fd9\u4e9b\u89c4\u5219\u6765\u67e5\u627e\u4e0e\u5176\u5339\u914d\u7684\u6570\u636e\u5305\u5e76\u4e3a\u7528\u6237\u751f\u6210\u8b66\u62a5\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"snort","permalink":"/blog/tags/snort"},{"label":"snort3","permalink":"/blog/tags/snort-3"},{"label":"ips","permalink":"/blog/tags/ips"}],"readingTime":1.1666666666666667,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/snort3","title":"snort3\u5b89\u88c5","authors":"gavintan","tags":["snort","snort3","ips"],"description":"Snort3 \u4e0b\u4e00\u4ee3Snort IPS\uff08\u5165\u4fb5\u9632\u5fa1\u7cfb\u7edf\uff09\uff0cSnort IPS \u4f7f\u7528\u4e00\u7cfb\u5217\u89c4\u5219\u6765\u5e2e\u52a9\u5b9a\u4e49\u6076\u610f\u7f51\u7edc\u6d3b\u52a8\uff0c\u5e76\u4f7f\u7528\u8fd9\u4e9b\u89c4\u5219\u6765\u67e5\u627e\u4e0e\u5176\u5339\u914d\u7684\u6570\u636e\u5305\u5e76\u4e3a\u7528\u6237\u751f\u6210\u8b66\u62a5\u3002","image":"https://raw.githubusercontent.com/GavinTan/files/master/picgo/20240118102006.png"},"unlisted":false,"prevItem":{"title":"hadoop\u5b89\u88c5","permalink":"/blog/hadoop"},"nextItem":{"title":"ProxySQL\u5b89\u88c5","permalink":"/blog/proxysql"}},"content":"## \u51c6\u5907\u73af\u5883\\n\\n```shell\\napt install -y build-essential autotools-dev libdumbnet-dev libluajit-5.1-dev libpcap-dev zlib1g-dev pkg-config libhwloc-dev cmake liblzma-dev openssl libssl-dev cpputest libsqlite3-dev libtool uuid-dev git autoconf bison flex libcmocka-dev libnetfilter-queue-dev libunwind-dev libmnl-dev ethtool libjemalloc-dev libpcre3-dev\\n```\\n\\n\\n\\n## \u7f16\u8bd1\u5b89\u88c5\\n\\n\u5b89\u88c5libdaq\\n\\n```shell\\ngit clone https://github.com/snort3/libdaq.git\\ncd libdaq\\n./bootstrap\\n./configure\\nmake -j 4\\nmake install\\nldconfig\\n```\\n\\n\u5b89\u88c5snort3\\n\\n```apt\\ngit clone https://github.com/snort3/snort3.git\\ncd snort3\\n./configure_cmake.sh --prefix=/usr/local/snort3 --enable-tcmalloc\\ncd build\\nmake -j 4\\nmake install\\n```\\n\\n\\n\\ncentos install:  [Snort_3_GA_on_OracleLinux_8.pdf](https://raw.githubusercontent.com/GavinTan/files/master/picgo/Snort_3_GA_on_OracleLinux_8.pdf) \\n\\n\\n\\n## \u914d\u7f6e\\n\\n\u8bbe\u7f6ealert_json\u542f\u7528\u65e5\u5fd7\u6587\u4ef6\\n\\n```shell\\ncat << EOF > /usr/local/snort3/etc/snort/snort.lua\\nalert_json =\\n{\\n    file = true,\\n    limit = 200\\n}\\nEOF\\n```\\n\\n\u6dfb\u52a0\u8b66\u62a5\u89c4\u5219\\n\\n```title=\\"/data/rules/local.rules\\"\\nalert icmp any any -> $HOME_NET any (msg:\\"[\u8b66\u544a]\u68c0\u6d4b\u5230 ICMP connection \u8bf7\u53ca\u65f6\u5904\u7406\\"; sid:1000001; rev:1;)\\n```\\n\\n\\n\\n## \u8fd0\u884c\\n\\n\u4e0b\u8f7dcommunity-rules\\n\\n```shell\\nwget https://www.snort.org/downloads/community/snort3-community-rules.tar.gz\\n```\\n\\n\u8fd0\u884csnort\uff08IDS\uff09\\n\\n```shell\\nsnort -c /usr/local/snort3/etc/snort/snort.lua -R /data/rules/snort3-community.rules -i ens192 -s 65535 -k none -A alert_fast -n 100000\\n\\n\\n# \u4fdd\u5b58\u65e5\u5fd7\\nsnort -c /usr/local/snort3/etc/snort/snort.lua -R /data/rules/snort3-community.rules -i ens192 -s 65535 -k none -A alert_fast -l /data/logs\\n```\\n\\n\\n\\n## \u5e38\u7528\u64cd\u4f5c\\n\\n\u67e5\u770balert\u6a21\u5757\\n\\n```shell\\nsnort --help-modules | grep alert\\n```\\n\\n\\n\\n\\n\\n## \u8fd0\u884cdocker\u914d\u7f6e\\n\\n```dockerfile title=\\"Dockerfile\\"\\nfrom debian:stable-20231120\\n\\nrun apt update\\nrun apt install -y build-essential autotools-dev libdumbnet-dev libluajit-5.1-dev libpcap-dev zlib1g-dev pkg-config libhwloc-dev cmake liblzma-dev openssl libssl-dev cpputest libsqlite3-dev libtool uuid-dev git autoconf bison flex libcmocka-dev libnetfilter-queue-dev libunwind-dev libmnl-dev ethtool libjemalloc-dev libpcre3-dev\\n\\n\\nrun cd && git clone https://github.com/snort3/libdaq.git && cd libdaq && ./bootstrap && ./configure && make -j 4 && make install\\n\\nrun cd && git clone https://github.com/snort3/snort3.git && cd snort3 && ldconfig && ./configure_cmake.sh --prefix=/usr/local/snort3 && cd build && make -j 4 && make install\\n\\nrun echo \'PATH=$PATH:/usr/local/snort3/bin\' >> ~/.bashrc\\n\\nrun <<EOF cat >> /usr/local/snort3/etc/snort/snort.lua\\nalert_fast =\\n{\\n    file = true,\\n    limit = 200\\n}\\nEOF\\n```\\n\\n\\n\\n```yaml title=\\"docker-compose.yml\\"\\nservices:\\n  snort:\\n    build: .\\n    command: /usr/local/snort3/bin/snort -c /usr/local/snort3/etc/snort/snort.lua -R /data/rules/snort3-community.rules -i ens192 -s 65535 -k none -A alert_fast -l /data/logs\\n    network_mode: host\\n    volumes:\\n      - ./data:/data\\n      - /etc/localtime:/etc/localtime:ro\\n```"},{"id":"/proxysql","metadata":{"permalink":"/blog/proxysql","editUrl":"https://github.com/gavintan/blog/edit/main/blog/\u6570\u636e\u5e93/proxysql\u5b89\u88c5.md","source":"@site/blog/\u6570\u636e\u5e93/proxysql\u5b89\u88c5.md","title":"ProxySQL\u5b89\u88c5","description":"ProxySQL \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u9ad8\u6027\u80fd\u3001\u9ad8\u53ef\u7528\u6027\u3001\u6570\u636e\u5e93\u534f\u8bae\u611f\u77e5\u7684 MySQL \u4ee3\u7406\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"proxysql","permalink":"/blog/tags/proxysql"}],"readingTime":5.6066666666666665,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/proxysql","title":"ProxySQL\u5b89\u88c5","authors":"gavintan","tags":["proxysql"],"description":"ProxySQL \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u9ad8\u6027\u80fd\u3001\u9ad8\u53ef\u7528\u6027\u3001\u6570\u636e\u5e93\u534f\u8bae\u611f\u77e5\u7684 MySQL \u4ee3\u7406\u3002","image":"https://proxysql.com/wp-content/uploads/2020/04/ProxySQL-Text-and-Logo-Glow.png"},"unlisted":false,"prevItem":{"title":"snort3\u5b89\u88c5","permalink":"/blog/snort3"},"nextItem":{"title":"Percona-XtraDB-Cluster\u5b89\u88c5","permalink":"/blog/pxc"}},"content":"## \u5b89\u88c5\\n\\n```shell\\ncat <<EOF | tee /etc/yum.repos.d/proxysql.repo\\n[proxysql_repo]\\nname= ProxySQL YUM repository\\nbaseurl=https://repo.proxysql.com/ProxySQL/proxysql-2.1.x/centos/\\\\$releasever\\ngpgcheck=1\\ngpgkey=https://repo.proxysql.com/ProxySQL/repo_pub_key\\nEOF\\n\\nyum install proxysql -y\\n```\\n\\n\\n\\n## \u6dfb\u52a0mysql\u96c6\u7fa4\u8282\u70b9\\n\\n:::tip\\n\\n\u540c\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u5b58\u5728\u591a\u4e2ahostgroup\u91cc\\n\\n:::\\n\\n```sql\\nmysql -u admin -padmin -h 127.0.0.1 -P 6032\\n\\nINSERT INTO mysql_servers(hostgroup_id, hostname, port, use_ssl) VALUES (0,\'192.168.70.71\',3306,1);\\nINSERT INTO mysql_servers(hostgroup_id, hostname, port, use_ssl) VALUES (0,\'192.168.70.72\',3306,1);\\nINSERT INTO mysql_servers(hostgroup_id, hostname, port, use_ssl) VALUES (0,\'192.168.70.73\',3306,1);\\n\\n\\n# \u4fdd\u5b58\u914d\u7f6e\\nLOAD MYSQL SERVERS TO RUNTIME;\\nSAVE MYSQL SERVERS TO DISK;\\n```\\n\\n\u67e5\u770b\\n\\n```sql\\nSELECT * FROM mysql_servers;\\n```\\n\\n\\n\\n## \u6dfb\u52a0\u5ba2\u6237\u7aef\u767b\u5f55\u7528\u6237\\n\\n:::warning\\n\\n\u7528\u6237\u5fc5\u987b\u5728mysql\u8282\u70b9\u4e2d\u5b58\u5728\u8d26\u53f7\u5bc6\u7801\u4e00\u6837\uff0c\u76ee\u524dproxysql\u53ea\u652f\u6301mysql_native_password\u5bc6\u7801\u63d2\u4ef6\uff0c\u5728mysql\u8282\u70b9\u6dfb\u52a0\u7528\u6237\u65f6\u5019\u5fc5\u987b\u6307\u5b9a\u63d2\u4ef6\u4e3amysql_native_password\u3002\\n\\n:::\\n\\n```sql\\n# mysql\u8282\u70b9\u4e2d\u6267\u884c\\nCREATE USER \'root\'@\'%\' IDENTIFIED WITH mysql_native_password by \'123456\';\\nGRANT ALL PRIVILEGES ON *.* TO \'root\'@\'%\' WITH GRANT OPTION;\\n```\\n\\n\u901a\u8fc7\u5b9a\u4e49default_hostgroup\u6211\u4eec\u6307\u5b9a\u7528\u6237\u5e94\u8be5\u9ed8\u8ba4\u8fde\u63a5\u5230\u6307\u5b9a\u76f8\u540chostgroup_id\u540e\u7aef\u670d\u52a1\u5668\\n\\n```sql\\n# proxysql\u4e2d\u6267\u884c\\nINSERT INTO mysql_users (username,password,default_hostgroup) VALUES (\'root\',\'123456\',0);\\nLOAD MYSQL USERS TO RUNTIME;\\nSAVE MYSQL USERS TO DISK;\\n```\\n\\n\u9ed8\u8ba4\u660e\u6587\u5bc6\u7801\u901a\u8fc7\u4e0b\u9762\u751f\u6210\u52a0\u5bc6\u5bc6\u7801\\n\\n```sql\\nload mysql users to runtime\\nsave mysql users to memory;\\nsave mysql users to disk;\\n```\\n\\n\u67e5\u770b\\n\\n```sql\\nSELECT * FROM mysql_users;\\n```\\n\\n\\n\\n## \u8fde\u63a5\\n\\nadmin\u7ba1\u7406\u63a5\u53e3\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a6032\u3002\u8be5\u7aef\u53e3\u7528\u4e8e\u67e5\u770b\u3001\u914d\u7f6eProxySQL\u3002\\n\\n\u63a5\u6536SQL\u8bed\u53e5\u7684\u63a5\u53e3\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a6033\uff0c\u8be5\u7aef\u53e3\u7528\u4e8emysql\u5ba2\u6237\u7aef\u8fde\u63a5\u3002\\n\\n\\n\\n## \u5176\u4ed6\u914d\u7f6e\\n\\n1. **\u914d\u7f6e\u76d1\u63a7\u7528\u6237**\\n\\n   > \u5728mysql\u8282\u70b9\u4e2d\u6267\u884c\u521b\u5efa\u76d1\u63a7\u7528\u6237\\n\\n   ```sql\\n   CREATE USER \'proxysql\'@\'%\' IDENTIFIED WITH mysql_native_password by \'123456\';\\n   GRANT USAGE ON *.* TO \'proxysql\'@\'%\';\\n   ```\\n\\n   > \u5728proxysql\u4e2d\u6267\u884c\u8bbe\u7f6e\u76d1\u63a7\u7528\u6237\u8d26\u53f7\u5bc6\u7801\\n\\n   ```sql\\n   UPDATE global_variables SET variable_value=\'proxysql\' WHERE variable_name=\'mysql-monitor_username\';\\n   UPDATE global_variables SET variable_value=\'123456\' WHERE variable_name=\'mysql-monitor_password\';\\n   \\n   LOAD MYSQL VARIABLES TO RUNTIME;\\n   SAVE MYSQL VARIABLES TO DISK;\\n   ```\\n\\n   \u67e5\u770b\u76d1\u63a7\u4fe1\u606f\\n\\n   ```sql\\n   SELECT * FROM monitor.mysql_server_connect_log ORDER BY time_start_us DESC LIMIT 6;\\n   SELECT * FROM monitor.mysql_server_ping_log ORDER BY time_start_us DESC LIMIT 6;\\n   ```\\n\\n2. **\u914d\u7f6eread_only\u76d1\u63a7\u548c\u8bfb/\u5199\u7ec4**\\n\\n   > mysql\u8282\u70b9\u6709read_only=0\u7684hostgroup\u5c06\u81ea\u52a8\u8bbe\u7f6e\u4e3a0\uff0cread_only=1\u8bbe\u7f6e\u62101\\n\\n   ```sql\\n   INSERT INTO mysql_replication_hostgroups (writer_hostgroup,reader_hostgroup,comment) VALUES (0,1,\'cluster1\');\\n   \\n   LOAD MYSQL SERVERS TO RUNTIME;\\n   SAVE MYSQL SERVERS TO DISK;\\n   ```\\n\\n   >\u8bbe\u7f6e\u6267\u884c\u53ea\u8bfb\u68c0\u67e5\u7684\u9891\u7387\uff0c\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u3002\\n\\n   ```sql\\n   UPDATE global_variables SET variable_value=5000 WHERE variable_name=\'mysql-monitor_read_only_interval\';\\n   ```\\n\\n   > \u8bbe\u7f6e\u53ea\u8bfb\u68c0\u67e5\u8d85\u65f6\u65f6\u95f4\uff08\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\uff09\\n\\n   ```sql\\n   UPDATE global_variables SET variable_value=5000 WHERE variable_name=\'mysql-monitor_read_only_timeout\';\\n   \\n   LOAD MYSQL VARIABLES TO RUNTIME;\\n   SAVE MYSQL VARIABLES TO DISK;\\n   \\n   # \u67e5\u770b\\n   SELECT * FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 3;\\n   ```\\n\\n3. **\u542f\u7528\u524d\u7aef\u7684 SSL/TLS\uff08zabbix\u8fde\u63a5\u4e4b\u7c7b\uff09**\\n\\n   ```sql\\n   SET mysql-have_ssl=\\"true\\";\\n   LOAD MYSQL VARIABLES TO RUNTIME;\\n   SAVE MYSQL VARIABLES TO DISK;\\n   \\n   # \u67e5\u770b\\n   SELECT * FROM global_variables WHERE variable_name LIKE \'mysql%ssl%\';\\n   ```\\n\\n4. **\u8bbe\u7f6e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684 MySQL \u7248\u672c\u53f7\uff08zabbix-server\u9650\u5b9a\u5ba2\u6237\u7aef\u7248\u672c\u4e4b\u7c7b\uff09**\\n\\n   ```sql\\n   set mysql-server_version=\\"8.0.27\\";\\n   LOAD MYSQL VARIABLES TO RUNTIME;\\n   SAVE MYSQL VARIABLES TO DISK;\\n   \\n   # \u67e5\u770b\\n   SELECT * FROM global_variables WHERE variable_name LIKE \'%version%\';\\n   ```\\n\\n5. **\u914d\u7f6e\u67e5\u8be2\u89c4\u5219**\\n\\n   - \u67e5\u8be2\u89c4\u5219\u6309rule_id\u4ece\u5c0f\u5230\u5927\u987a\u5e8f\u5904\u7406\\n   - \u4ec5\u5904\u7406\u5df2active=1\u5904\u7406\u7684\u89c4\u5219\\n   - \u7b2c\u4e00\u4e2a\u89c4\u5219\u793a\u4f8b\u4f7f\u7528\u63d2\u5165\u7b26\u53f7 ( ^) \u548c\u7f8e\u5143 ( $) \uff1a\u8fd9\u4e9b\u662f\u7279\u6b8a\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u5b57\u7b26\uff0c\u7528\u4e8e\u6807\u8bb0\u6a21\u5f0f\u7684\u5f00\u59cb\u548c\u7ed3\u675f\uff0c\u5373\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0bmatch_digest\u6216match_pattern\u5e94\u8be5\u5b8c\u5168\u5339\u914d\u67e5\u8be2\\n   - \u4e0d\u4f7f\u7528\u63d2\u5165\u7b26\u53f7\u6216\u7f8e\u5143\uff1a\u5339\u914d\u53ef\u4ee5\u5728\u67e5\u8be2\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\\n   - \u95ee\u53f7\u88ab\u8f6c\u4e49\uff0c\u56e0\u4e3a\u5b83\u5728\u6b63\u5219\u8868\u8fbe\u5f0f\u4e2d\u5177\u6709\u7279\u6b8a\u542b\u4e49\\n   - apply=1\u8868\u793a\u5982\u679c\u5f53\u524d\u89c4\u5219\u5339\u914d\u5219\u4e0d\u4f1a\u7ee7\u7eed\u5339\u914d\u540e\u7684\u89c4\u5219\\n   - match_digest\uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u53bb\u9664 SQL \u67e5\u8be2\u6570\u636e\u7684\u67e5\u8be2\u6458\u8981\u8fdb\u884c\u5339\u914d\uff08\u4f8b\u5982 `SELECT c FROM sbtest1 WHERE id=?`\uff0c\u5982stats_mysql_query_digest.query_digest\uff09\\n   - match_pattern\uff1a\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0e\u67e5\u8be2\u7684\u5b9e\u9645\u6587\u672c\u5339\u914d\uff08\u4f8b\u5982\uff0c`SELECT c FROM sbtest1 WHERE id=2`\uff09\\n   - \u5f53\u5165\u53e3\u503cflagIN\u8bbe\u7f6e\u4e3a0\u65f6\uff0c\u8868\u793a\u5f00\u59cb\u8fdb\u5165\u94fe\u5f0f\u89c4\u5219\u3002\\n   - \u5982\u672a\u663e\u5f0f\u6307\u5b9a\u89c4\u5219\u7684flagIN\u503c\uff0c\u5219\u9ed8\u8ba4\u90fd\u4e3a0\u3002\u5f53\u8bed\u53e5\u5339\u914d\u5b8c\u5f53\u524d\u89c4\u5219\u540e\uff0c\u5c06\u8bb0\u4e0b\u5f53\u524d\u89c4\u5219\u7684flagOUT\u503c\uff0c\u5982\u679cflagOUT\u503c\u975e\u7a7a(NOT NULL)\uff0c\u5219\u4e3a\u8be5\u8bed\u53e5\u6253\u4e0aflagOUT\u6807\u8bb0\u3002\u5982\u679c\u8be5\u89c4\u5219\u7684apply\u5b57\u6bb5\u503c\u4e0d\u662f1\uff0c\u5219\u7ee7\u7eed\u5411\u4e0b\u5339\u914d\u3002\u5982\u679c\u8bed\u53e5\u7684flagOUT\u6807\u8bb0\u548c\u4e0b\u4e00\u6761\u89c4\u5219\u7684flagIN\u503c\u4e0d\u540c\uff0c\u5219\u8df3\u8fc7\u8be5\u89c4\u5219\uff0c\u7ee7\u7eed\u5411\u4e0b\u5339\u914d\u3002\u76f4\u5230\u5339\u914d\u5230flagOUT=flagIN\u7684\u89c4\u5219\uff0c\u5219\u5339\u914d\u8be5\u89c4\u5219\u3002\u8be5\u89c4\u5219\u662f\u94fe\u5f0f\u89c4\u5219\u4e2d\u7684\u53e6\u4e00\u6761\u89c4\u5219\u3002\u76f4\u5230\u67d0\u89c4\u5219\u7684apply\u5b57\u6bb5\u8bbe\u7f6e\u4e3a1\uff0c\u6216\u8005\u5df2\u7ecf\u5339\u914d\u5b8c\u6240\u6709\u89c4\u5219\uff0c\u5219\u6700\u540e\u4e00\u6b21\u88ab\u8bc4\u4f30\u7684\u89c4\u5219\u5c06\u76f4\u63a5\u751f\u6548\uff0c\u4e0d\u518d\u7ee7\u7eed\u5411\u4e0b\u5339\u914d\u3002\\n\\n   \\n\\n   :::tip\\n\\n   \u5982\u679c\u60f3\u5bf9match_digest\u53d6\u53cd\uff0c\u5373\u4e0d\u88ab\u6b63\u5219\u5339\u914d\u7684SQL\u8bed\u53e5\u624d\u547d\u4e2d\u89c4\u5219\uff0c\u5219\u8bbe\u7f6emysql_query_rules\u8868\u4e2d\u7684\u5b57\u6bb5negate_match_pattern=1\u3002\u540c\u6837\u9002\u7528\u4e8e\u4e0b\u9762\u7684match_pattern\u5339\u914d\u65b9\u5f0f\u3002\\n\\n   \u6458\u8981\u603b\u662f\u6bd4\u67e5\u8be2\u672c\u8eab\u5c0f\uff0c\u5bf9\u8f83\u5c0f\u7684\u5b57\u7b26\u4e32\u8fd0\u884c\u6b63\u5219\u8868\u8fbe\u5f0f\u4f1a\u66f4\u5feb\uff0c\u5efa\u8bae\uff08\u51fa\u4e8e\u6027\u80fd\u8003\u8651\uff09\u4f7f\u7528match_digest. \u8981\u91cd\u5199\u67e5\u8be2\u6216\u5339\u914d\u67e5\u8be2\u6587\u672c\u672c\u8eab\uff0c\u8bf7\u4f7f\u7528match_pattern.\\n\\n   :::\\n\\n   > \u67e5\u770b\u8bed\u53e5\u5339\u914d\\n\\n   ```sql\\n   INSERT INTO mysql_query_rules (rule_id,active,username,match_digest,destination_hostgroup,apply) VALUES (10,1,\'stnduser\',\'^SELECT * FROM sbtest1 WHERE id=\\\\?$\',10,1);\\n   \\n   INSERT INTO mysql_query_rules (rule_id,active,username,match_digest,destination_hostgroup,apply) VALUES (10,1,\'stnduser\',\'^SELECT\',10,1);\\n   ```\\n\\n   > \u6570\u636e\u5e93\u540d\u79f0\u5339\u914d\uff08\u4e0d\u5229\u7528 use databases \u5e76\u4e14\u4e0d\u547d\u4e2d\u5176\u4ed6\u89c4\u5219\uff0c\u9ed8\u8ba4\u8f6c\u53d1\u5230\u7528\u6237 default_hostgroup\uff09\\n\\n   ```sql\\n   instert into mysql_query_rules (rule_id, active, schemaname, destination_hostgroup,apply) values(1,1,\'aa\', 10, 1);\\n   ```\\n\\n   > \u5ba2\u6237\u7aefIP\u5339\u914d\\n\\n   ```sql\\n   insert into mysql_query_rules (rule_id, active, client_addr, destination_hostgroup) values(2,1,\'192.168.8.192\', 10);\\n   ```\\n\\n   >\u7981\u6b62\u67e5\u8be2\uff0c\u53ef\u4ee5\u914d\u5408\u5ba2\u6237\u7aefip\u7b56\u7565\u8bbe\u7f6e\u767d\u540d\u5355\\n\\n   ```sql\\n   insert into mysql_query_rules (rule_id, active, match_digest, error_msg) values(3,1,\'.\',\'error 9999\');\\n   ```\\n\\n   > \u67e5\u8be2\u91cd\u5199\\n\\n   ```sql\\n   INSERT INTO mysql_query_rules (rule_id,active,username,match_pattern,replace_pattern,apply) VALUES (30,1,\'root\',\'DISTINCT(.*)ORDER BY c\',\'DISTINCT\\\\1\',1);\\n   ```\\n\\n   > \u67e5\u8be2\u7f13\u5b58 cache_ttl(\u6beb\u79d2)\\n\\n   ```sql\\n   UPDATE mysql_query_rules set cache_ttl=5000 WHERE rule_id=10;\\n   ```\\n\\n   \u4fdd\u5b58\u89c4\u5219\u914d\u7f6e\\n\\n   ```sql\\n   LOAD MYSQL QUERY RULES TO RUNTIME;\\n   SAVE MYSQL QUERY RULES TO DISK;\\n   \\n   # \u67e5\u770b\\n   SELECT match_digest,destination_hostgroup FROM mysql_query_rules;\\n   \\n   SELECT rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, apply FROM mysql_query_rules ORDER BY rule_id;\\n   # \u67e5\u770bhg(\u4e3b\u673a\u7ec4)=-1\u4e3a\u7f13\u5b58\u67e5\u8be2\\n   SELECT hostgroup hg, sum_time, count_star, digest_text FROM stats_mysql_query_digest ORDER BY sum_time DESC limit 10;\\n   ```\\n\\n   \\n\\n## \u5168\u5c40\u53d8\u91cf\\n\\n| \u53d8\u91cf                                | \u9ed8\u8ba4\u503c       | \u8bf4\u660e                                                         |\\n| ----------------------------------- | ------------ | ------------------------------------------------------------ |\\n| admin-admin_credentials             | admin:admin  | \u7ba1\u7406\u7aef\u53e3\u7528\u6237\u540d\u548c\u5bc6\u7801                                         |\\n| admin-mysql_ifaces                  | 0.0.0.0:6032 | \u7ba1\u7406\u7aef\u53e3                                                     |\\n| admin-stats_credentials             | stats:stats  | \u6570\u636e\u7aef\u53e3\u7528\u6237\u540d\u548c\u5bc6\u7801                                         |\\n| mysql-commands_stats                | true         | \u662f\u5426\u5f00\u542f SQL \u7edf\u8ba1\uff0c\u5f00\u542f\u540e\u4f1a\u5206\u6790\u6bcf\u6761 SQL \u8bed\u53e5                 |\\n| mysql-connection_max_age_ms         | 0            | \u5230 Backend \u7684\u8fde\u63a5\u7a7a\u95f2\u591a\u4e45\u540e\u4f1a\u81ea\u52a8\u5173\u95ed                        |\\n| mysql-default_query_timeout         | 86400000     | \u5230 Backend \u7684\u67e5\u8be2\u8d85\u65f6\u65f6\u95f4\uff08\u6beb\u79d2\uff09\uff0c\u8d85\u8fc7\u540e\u4f1a\u4e3b\u52a8\u505c\u6b62\u67e5\u8be2\uff0c\u5e76\u4ece Backend Kill \u6389\u8be5\u8fde\u63a5 |\\n| mysql-free_connections_pct          | 10           | \u5141\u8bb8\u7684 Backend \u7a7a\u95f2\u8fde\u63a5\u6570\uff0c\u662f\u4e00\u4e2a\u5360 mysql-max_connections \u6570\u91cf\u7684\u767e\u5206\u6bd4 |\\n| mysql-interfaces                    | 0.0.0.0:6033 | \u6570\u636e\u7aef\u53e3\u914d\u7f6e                                                 |\\n| mysql-max_connections               | 2048         | ProxySQL \u53ef\u63a5\u6536\u7684\u6700\u5927\u8fde\u63a5\u6570\u3002\u9ed8\u8ba4 10000\u3002                    |\\n| mysql-server_version                | 5.5.30       | ProxySQL \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684 MySQL \u7248\u672c\u53f7\uff0c\u6709\u53ef\u80fd\u5f71\u54cd\u5ba2\u6237\u7aef\u884c\u4e3a   |\\n| mysql-session_idle_show_processlist | true         | \u7ba1\u7406\u7aef\u53e3\u8fdb\u884c show processlist \u65f6\uff0c\u662f\u5426\u663e\u793a\u7a7a\u95f2\u8fde\u63a5\uff0c\u5f00\u542f\u540e\u4f1a\u5f71\u54cd\u6027\u80fd |\\n| mysql-wait_timeout                  | 28800000     | \u5ba2\u6237\u7aef\u8fde\u63a5\u7a7a\u95f2\u8d85\u65f6\u65f6\u95f4\uff08\u6beb\u79d2\uff09                               |\\n\\n\u4fee\u6539\\n\\n```sql\\nset admin-admin_credentials=\'admin:admin;myuser:myuser\';\\n\\n# \u4f7f\u4fee\u6539\u7acb\u5373\u751f\u6548\\nload admin variables to runtime;\\n# \u4f7f\u4fee\u6539\u6c38\u4e45\u4fdd\u5b58\u5230\u78c1\u76d8\\nsave admin variables to disk;\\n```\\n\\n\u67e5\u770b\\n\\n```sql\\nSELECT * FROM global_variables;\\nSELECT @@admin-stats_credentials;\\nSHOW VARIABLES LIKE \\"mysql-max_connections\\";\\n```"},{"id":"/pxc","metadata":{"permalink":"/blog/pxc","editUrl":"https://github.com/gavintan/blog/edit/main/blog/\u6570\u636e\u5e93/pxc\u96c6\u7fa4\u5b89\u88c5.md","source":"@site/blog/\u6570\u636e\u5e93/pxc\u96c6\u7fa4\u5b89\u88c5.md","title":"Percona-XtraDB-Cluster\u5b89\u88c5","description":"Percona XtraDB Cluster\u662f MySQL \u7684\u6570\u636e\u5e93\u96c6\u7fa4\u89e3\u51b3\u65b9\u6848\u3002\u5b83\u786e\u4fdd\u9ad8\u53ef\u7528\u6027\uff0c\u9632\u6b62\u505c\u673a\u548c\u6570\u636e\u4e22\u5931\uff0c\u5e76\u4e3a\u4e0d\u65ad\u589e\u957f\u7684\u73af\u5883\u63d0\u4f9b\u7ebf\u6027\u53ef\u6269\u5c55\u6027\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"Percona XtraDB Cluster","permalink":"/blog/tags/percona-xtra-db-cluster"},{"label":"pxc","permalink":"/blog/tags/pxc"},{"label":"Percona","permalink":"/blog/tags/percona"}],"readingTime":1.6566666666666667,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/pxc","title":"Percona-XtraDB-Cluster\u5b89\u88c5","authors":"gavintan","tags":["Percona XtraDB Cluster","pxc","Percona"],"description":"Percona XtraDB Cluster\u662f MySQL \u7684\u6570\u636e\u5e93\u96c6\u7fa4\u89e3\u51b3\u65b9\u6848\u3002\u5b83\u786e\u4fdd\u9ad8\u53ef\u7528\u6027\uff0c\u9632\u6b62\u505c\u673a\u548c\u6570\u636e\u4e22\u5931\uff0c\u5e76\u4e3a\u4e0d\u65ad\u589e\u957f\u7684\u73af\u5883\u63d0\u4f9b\u7ebf\u6027\u53ef\u6269\u5c55\u6027\u3002"},"unlisted":false,"prevItem":{"title":"ProxySQL\u5b89\u88c5","permalink":"/blog/proxysql"},"nextItem":{"title":"Wireguard\u5b89\u88c5","permalink":"/blog/wireguard"}},"content":"## pxc\u96c6\u7fa4\u7279\u70b9\\n\\n\\n| \u7279\u70b9                | \u8bf4\u660e                                                         |\\n| ------------------- | ------------------------------------------------------------ |\\n| \u540c\u6b65\u590d\u5236            | \u6570\u636e\u540c\u65f6\u5199\u5165\u6240\u6709\u8282\u70b9\uff0c\u6216\u8005\u5373\u4f7f\u5728\u5355\u4e2a\u8282\u70b9\u4e0a\u4e5f\u53d1\u751f\u6545\u969c\u65f6\u6839\u672c\u4e0d\u5199\u5165 |\\n| \u591a\u6e90\u590d\u5236            | \u4efb\u4f55\u8282\u70b9\u90fd\u53ef\u4ee5\u89e6\u53d1\u6570\u636e\u66f4\u65b0\u3002                                 |\\n| \u771f\u6b63\u7684\u5e76\u884c\u590d\u5236      | \u526f\u672c\u4e0a\u7684\u591a\u4e2a\u7ebf\u7a0b\u5728\u884c\u7ea7\u522b\u6267\u884c\u590d\u5236                             |\\n| \u81ea\u52a8\u8282\u70b9\u8c03\u914d        | \u53ea\u9700\u6dfb\u52a0\u4e00\u4e2a\u8282\u70b9\uff0c\u5b83\u5c31\u4f1a\u81ea\u52a8\u540c\u6b65\u3002                           |\\n| \u6570\u636e\u4e00\u81f4\u6027          | \u4e0d\u518d\u6709\u4e0d\u540c\u6b65\u7684\u8282\u70b9\u3002                                         |\\n| PXC \u4e25\u683c\u6a21\u5f0f        | \u907f\u514d\u4f7f\u7528\u6280\u672f\u9884\u89c8\u529f\u80fd\u548c\u4e0d\u53d7\u652f\u6301\u7684\u529f\u80fd                         |\\n| ProxySQL \u7684\u914d\u7f6e\u811a\u672c | Percona XtraDB Cluster\u5305\u542bproxysql-admin\u5de5\u5177\uff0c\u8be5\u5de5\u5177\u80fd\u591f\u81ea\u52a8\u914d\u7f6e\u4f7f\u7528ProxySQL\u7684Percona XtraDB Cluster\u8282\u70b9\u3002 |\\n| SSL\u52a0\u5bc6\u7684\u81ea\u52a8\u914d\u7f6e   | Percona XtraDB Cluster\u5305\u542bpxc-encrypt-cluster-traffic\u53d8\u91cf\uff0c\u8be5\u53d8\u91cf\u542f\u7528SSL\u52a0\u5bc6\u7684\u81ea\u52a8\u914d\u7f6e |\\n| \u4f18\u5316\u6027\u80fd            | Percona XtraDB Cluster\u7684\u6027\u80fd\u88ab\u4f18\u5316\uff0c\u4ee5\u9002\u5e94\u4e0d\u65ad\u589e\u957f\u7684\u751f\u4ea7\u8d1f\u8f7d |\\n\\n\\n\\n## \u51c6\u5907\u73af\u5883\\n\\n~~~shell\\nyum install -y openssl socat  \\\\\\nprocps-ng chkconfig procps-ng coreutils shadow-utils \\\\\\ngrep libaio libev libcurl perl-DBD-MySQL perl-Digest-MD5 \\\\\\nlibgcc libstdc++ libgcrypt libgpg-error zlib glibc openssl-libs\\n\\nuseradd -M -s /sbin/nologin mysql\\nmkdir -p /data/mysql /var/run/mysqld  /var/log/mysqld\\nchown -R mysql. /data/mysql /var/run/mysqld  /var/log/mysqld\\n~~~\\n\\n\\n\\n## \u5b89\u88c5\\n\\n~~~shell\\nwget https://downloads.percona.com/downloads/Percona-XtraDB-Cluster-80/Percona-XtraDB-Cluster-8.0.27/binary/tarball/Percona-XtraDB-Cluster_8.0.27-18.1_Linux.x86_64.glibc2.17-minimal.tar.gz\\ntar zxf Percona-XtraDB-Cluster_8.0.27-18.1_Linux.x86_64.glibc2.17-minimal.tar.gz\\nmkdir -p /usr/local/percona\\nmv Percona-XtraDB-Cluster_8.0.27-18.1_Linux.x86_64.glibc2.17-minimal /usr/local/percona/mysql\\n\\ncp /usr/local/percona/mysql/support-files/mysql.server /etc/init.d/mysqld\\nsed -i \'s/^basedir=.*/basedir=\\\\/usr\\\\/local\\\\/percona\\\\/mysql/\' /etc/init.d/mysqld\\nsed -i \'s/^datadir=.*/datadir=\\\\/data\\\\/mysql/\' /etc/init.d/mysqld\\n\\ncat <<EOF > /etc/profile.d/mysql.sh\\nexport PATH=$PATH:/usr/local/percona/mysql/bin\\nEOF\\nsource /etc/proflie\\n~~~\\n\\n\u751f\u6210\u914d\u7f6e\u6587\u4ef6\\n\\n> \u4e0d\u540c\u8282\u70b9\u9700\u8981\u4fee\u6539`server-id`\u3001`wsrep_node_name`\u3001`wsrep_node_address`\\n\\n~~~shell\\ncat <<EOF > /etc/my.cnf.d/pxc.cnf\\n[client]\\nsocket=/var/run/mysqld/mysql.sock\\n\\n[mysqld]\\nbasedir=/usr/local/percona/mysql\\ndatadir=/data/mysql\\n\\nsocket=/var/run/mysqld/mysql.sock\\npid-file=/var/run/mysqld/mysqld.pid\\nlog-error=/var/log/mysqld/mysqld.log\\n\\nserver-id=14\\nuser=mysql\\n\\nlog-bin\\nbinlog_format=ROW\\nbinlog_expire_logs_seconds=604800\\n\\ninnodb_autoinc_lock_mode=2\\ndefault_storage_engine=InnoDB\\nlog_timestamps=SYSTEM\\n\\n######## wsrep ###############\\nwsrep_cluster_name=pxc-cluster-tt\\nwsrep_cluster_address=gcomm://172.16.7.14,172.16.7.15,172.16.7.16\\nwsrep_node_name=pxc-node-14\\nwsrep_node_address=172.16.7.14\\nwsrep_applier_threads=8\\nwsrep_log_conflicts\\npxc_strict_mode=ENFORCING\\nwsrep_sst_method=xtrabackup-v2\\nwsrep_provider=/usr/local/percona/mysql/lib/libgalera_smm.so\\nwsrep_provider_options=\\"socket.ssl_key=server-key.pem;socket.ssl_cert=server-cert.pem;socket.ssl_ca=ca.pem\\"\\n\\n\\n[sst]\\nencrypt=4\\nssl-key=server-key.pem\\nssl-ca=ca.pem\\nssl-cert=server-cert.pem\\nEOF\\n~~~\\n\\n\\n\\n## \u521d\u59cb\u5316\u6570\u636e\u5e93\\n\\n~~~shell\\nmysqld --initialize\\n~~~\\n\\n\\n\\n## \u542f\u52a8\u6570\u636e\u5e93\\n\\n:::tip\\n\\n\u4ece 8.0.31 \u7248\u672c\u5f00\u59cb\uff0cSST \u590d\u5236\u5728 root \u7528\u6237\u4e0b\u505c\u6b62\u5de5\u4f5c\u3002myqld\u4e0d\u80fd\u5728root\u4e0b\u542f\u52a8\uff01\\n\\n```shell\\nsu mysql -s /bin/bash -c \'/etc/init.d/mysqld start\'\\n```\\n\\n:::\\n\\n~~~shell\\n#\u7b2c\u4e00\u4e2a\u542f\u52a8\u8282\u70b9\u5fc5\u987b\u4f7f\u7528bootstrap-pxc\u65b9\u5f0f\uff0c\u987b\u6ce8\u91cafunctions\u4e0d\u4f7f\u7528systemd\u4e0d\u7136bootstrap-pxc\u53c2\u6570\u65e0\u6548\\nsed -i \'s/^. \\\\/etc\\\\/rc.d\\\\/init.d\\\\/functions/#&/\' /etc/init.d/mysqld\\n/etc/init.d/mysqld bootstrap-pxc\\n\\n#\u5176\u4ed6\u8282\u70b9\u542f\u52a8\\n#\u540c\u6b65\u8bc1\u4e66\uff0c\u5176\u4ed6\u8282\u70b9\u5fc5\u987b\u4f7f\u7528\u7b2c\u4e00\u4e2a\u542f\u52a8\u8282\u70b9\u7684\u8bc1\u4e66\\nrsync -aP 172.16.7.14:/data/mysql/*.pem /data/mysql\\n/etc/init.d/mysqld start\\n~~~"},{"id":"/wireguard","metadata":{"permalink":"/blog/wireguard","editUrl":"https://github.com/gavintan/blog/edit/main/blog/\u7f51\u7edc/wireguard.md","source":"@site/blog/\u7f51\u7edc/wireguard.md","title":"Wireguard\u5b89\u88c5","description":"WireGuard\u662f\u4e00\u79cd\u6781\u5176\u7b80\u5355\u4f46\u5feb\u901f\u4e14\u73b0\u4ee3\u7684 VPN\uff0c\u91c7\u7528\u6700\u5148\u8fdb\u7684\u52a0\u5bc6\u6280\u672f\u3002\u5b83\u7684\u76ee\u6807\u662f\u6bd4 IPsec\u66f4\u5feb\u3001\u66f4\u7b80\u5355\u3001\u66f4\u7cbe\u7b80\u3001\u66f4\u6709\u7528\uff0c\u540c\u65f6\u907f\u514d\u4ee4\u4eba\u5934\u75bc\u7684\u95ee\u9898\u3002\u5b83\u7684\u6027\u80fd\u8fdc\u9ad8\u4e8e OpenVPN\u3002","date":"2024-08-27T09:10:11.000Z","tags":[{"label":"WireGuard","permalink":"/blog/tags/wire-guard"},{"label":"WG","permalink":"/blog/tags/wg"}],"readingTime":5.86,"hasTruncateMarker":false,"authors":[{"name":"GavinTan","title":"DevOps Engineer","url":"https://github.com/GavinTan","imageURL":"/img/logo.webp","key":"gavintan"}],"frontMatter":{"slug":"/wireguard","title":"Wireguard\u5b89\u88c5","authors":"gavintan","tags":["WireGuard","WG"],"keywords":["WireGuard","WG"],"description":"WireGuard\u662f\u4e00\u79cd\u6781\u5176\u7b80\u5355\u4f46\u5feb\u901f\u4e14\u73b0\u4ee3\u7684 VPN\uff0c\u91c7\u7528\u6700\u5148\u8fdb\u7684\u52a0\u5bc6\u6280\u672f\u3002\u5b83\u7684\u76ee\u6807\u662f\u6bd4 IPsec\u66f4\u5feb\u3001\u66f4\u7b80\u5355\u3001\u66f4\u7cbe\u7b80\u3001\u66f4\u6709\u7528\uff0c\u540c\u65f6\u907f\u514d\u4ee4\u4eba\u5934\u75bc\u7684\u95ee\u9898\u3002\u5b83\u7684\u6027\u80fd\u8fdc\u9ad8\u4e8e OpenVPN\u3002"},"unlisted":false,"prevItem":{"title":"Percona-XtraDB-Cluster\u5b89\u88c5","permalink":"/blog/pxc"}},"content":"WireGuard\u662f\u4e00\u79cd\u6781\u5176\u7b80\u5355\u4f46\u5feb\u901f\u4e14\u73b0\u4ee3\u7684 VPN\uff0c\u91c7\u7528\u6700\u5148\u8fdb\u7684\u52a0\u5bc6\u6280\u672f\u3002\u5b83\u7684\u76ee\u6807\u662f\u6bd4 IPsec\u66f4\u5feb\u3001\u66f4\u7b80\u5355\u3001\u66f4\u7cbe\u7b80\u3001\u66f4\u6709\u7528\uff0c\u540c\u65f6\u907f\u514d\u4ee4\u4eba\u5934\u75bc\u7684\u95ee\u9898\u3002\u5b83\u7684\u6027\u80fd\u8fdc\u9ad8\u4e8e OpenVPN\u3002WireGuard \u88ab\u8bbe\u8ba1\u4e3a\u901a\u7528 VPN\uff0c\u53ef\u5728\u5d4c\u5165\u5f0f\u63a5\u53e3\u548c\u8d85\u7ea7\u8ba1\u7b97\u673a\u4e0a\u8fd0\u884c\uff0c\u9002\u5408\u8bb8\u591a\u4e0d\u540c\u7684\u60c5\u51b5\u3002\u5b83\u6700\u521d\u9488\u5bf9 Linux \u5185\u6838\u53d1\u5e03\uff0c\u73b0\u5728\u5df2\u8de8\u5e73\u53f0\uff08Windows\u3001macOS\u3001BSD\u3001iOS\u3001Android\uff09\u4e14\u53ef\u5e7f\u6cdb\u90e8\u7f72\u3002\\n\\n\\n\\n## \u670d\u52a1\u5668\u5b89\u88c5\\n\\n[\u524d\u5f80\u5b98\u65b9\u5b89\u88c5\u6587\u6863](https://www.wireguard.com/install)\\n\\n> Linux\u5185\u6838\u5fc5\u987b>5.6\\n\\n~~~\\nyum install wireguard-tools\\n~~~\\n\\n\\n\\n## Quick Start\\n\\n[\u524d\u5f80\u914d\u7f6e\u6587\u6863](https://wiki.archlinux.org/title/WireGuard)\\n\\n1. \u5bc6\u94a5\u751f\u6210\\n\\n   ~~~shell\\n   umask 077\\n   wg genkey | tee privatekey | wg pubkey > publickey\\n   ~~~\\n\\n2. \u751f\u6210\u914d\u7f6e\u6587\u4ef6\\n\\n   >\u5f53\u5ba2\u6237\u7aef\u914d\u7f6e\u4e86AllowedIPs = 0.0.0.0/0\u4ee3\u7406\u6240\u6709\u6d41\u91cf\uff0c\u670d\u52a1\u5668\u7aef\u5fc5\u987b\u6dfb\u52a0PostUp\u7684iptables\u6765\u8f6c\u53d1\u6d41\u91cf\u5ba2\u6237\u7aef\u624d\u80fd\u6b63\u5e38\u4f7f\u7528\uff0c\u662f\u652f\u6301\u591a\u4e2aPeer\u7684\u4e5f\u5c31\u662f\u80fd\u540c\u65f6\u914d\u7f6e\u591a\u4e2a\u8fdc\u7a0b\u7aef\u70b9\u3002\\n   >\\n   >`AllowedIPs`\u901a\u4fd7\u7684\u6765\u8bf4\u5c31\u662f\u672c\u5730\u9700\u8981\u7ecf\u8fc7wireguard\u7684ip\u7f51\u6bb5\u90fd\u8981\u914d\u7f6e\u4e0a\\n\\n   ~~~shell\\n   umask 077\\n   cat <<EOF > /etc/wireguard/wg0.conf\\n   [Interface]\\n   PrivateKey = `cat privatekey`\\n   Address = 172.16.100.1/24\\t#\u5730\u5740\u987b\u552f\u4e00\\n   ListenPort = 51820\\t#udp\u7aef\u53e3\\n   PostUp = sysctl -w net.ipv4.ip_forward=1\\n   PostUp   = iptables -A FORWARD -i %i -j ACCEPT\\n   PostUp   = iptables -A FORWARD -o %i -j ACCEPT\\n   PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE\\n   PostDown = sysctl -w net.ipv4.ip_forward=0\\n   PostDown = iptables -D FORWARD -i %i -j ACCEPT\\n   PostDown = iptables -D FORWARD -o %i -j ACCEPT\\n   PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE\\n   \\n   [Peer]\\n   PublicKey = <\u5ba2\u6237\u7aef\u7684publickey>\\n   AllowedIPs = 172.16.100.2/32\\n   EOF\\n   ~~~\\n\\n3. \u542f\u52a8wireguard\\n\\n   ~~~shell\\n   wg-quick up wg0\\n   \\n   #\u8bbe\u7f6e\u5f00\u673a\u81ea\u542f\\n   systemctl enable wg-quick@wg0\\n   ~~~\\n\\n4. \u505c\u6b62wireguard\\n\\n   ~~~shell\\n   wg-quick down wg0\\n   \\n   #\u5220\u9664\u5f00\u673a\u81ea\u542f\\n   systemctl disable wg-quick@wg0\\n   ~~~\\n\\n   \\n\\n\\n\\n\\n\\n## \u5ba2\u6237\u7aef\u5b89\u88c5\\n\\n> \u5ba2\u6237\u7aef\u9700\u8981\u5168\u5c40\u6d41\u91cf\u8d70wireguard\u9700\u8981\u6dfb\u52a0AllowedIPs = 0.0.0.0/0\u914d\u7f6e\uff0c\u4e0d\u884c\u5168\u5c40\u6d41\u91cf\u90fd\u8d70wireguard\u53ea\u9700\u8981\u5728AllowedIPs \u914d\u7f6e\u9700\u8981\u7ecf\u8fc7vpn\u7684\u7f51\u6bb5\u6216ip\u5373\u53ef\\n>\\n> \u5982\u679c\u662f\u5728windows\u4e0a\u5ba2\u6237\u7aef\u6253\u901a\u96a7\u9053\u9700\u8981\u5728\u8fde\u63a5\u5c40\u57df\u7f51\u7684\u7f51\u5361\u4e0a\u8bbe\u7f6eInternet\u8fde\u63a5\u5171\u4eab\u5141\u8bb8\u672c\u5730wireguard Tunnel\u521b\u5efa\u7684\u7f51\u5361\\n\\n~~~shell\\n[Interface]\\nPrivateKey = <\u5ba2\u6237\u7aef\u7684privatekey>\\nAddress = 172.16.100.2/24\\t#\u5730\u5740\u987b\u552f\u4e00\u4e14\u540c\u670d\u52a1\u5668\u4e3a\u540c\u4e00\u7f51\u6bb5\\nDNS = 8.8.8.8,1.1.1.1\\n\\n[Peer]\\nPublicKey = <\u670d\u52a1\u5668\u7684publickey>\\nAllowedIPs = 0.0.0.0/0,::/0\\nEndpoint = <server>:51820\\nPersistentKeepalive = 25\\t#\u5f53\u670d\u52a1\u5668\u4f4d\u4e8eNAT\u6216\u9632\u706b\u5899\u540e\u9762\u65f6\u9700\u8981\u914d\u7f6ekeepalive\\n~~~\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n## \u7591\u96be\u89e3\u7b54\\n\\n#### \u4f7f\u7528\u52a8\u6001\u57df\u540d\u4e4b\u7c7b\u7684ip\u53d1\u751f\u53d8\u5316\u4e0d\u4f1a\u81ea\u52a8\u91cd\u8fde\\n\\n~~~shell\\ngit clone https://git.zx2c4.com/wireguard-tools /usr/share/wireguard-tools\\n\\n\\ncat <<EOF > /etc/systemd/system/wireguard_reresolve-dns.timer\\n[Unit]\\nDescription=Periodically reresolve DNS of all WireGuard endpoints\\n\\n[Timer]\\nOnCalendar=*:*:0/30\\n\\n[Install]\\nWantedBy=timers.target\\nEOF\\n\\n\\n\\ncat <<EOF > /etc/systemd/system/wireguard_reresolve-dns.service\\n[Unit]\\nDescription=Reresolve DNS of all WireGuard endpoints\\nWants=network-online.target\\nAfter=network-online.target\\n\\n[Service]\\nType=oneshot\\nExecStart=/bin/sh -c \'for i in /etc/wireguard/*.conf; do /usr/share/wireguard-tools/contrib/reresolve-dns/reresolve-dns.sh \\"$i\\"; done\'\\nEOF\\n\\n\\n\\nsystemctl enable wireguard_reresolve-dns.timer --now\\n~~~\\n\\n\\n\\n#### \u9047\u5230\u8fd0\u8425\u5546UDP\u9650\u901f\uff08QOS\uff09\\n\\nWireGuard \u5728\u56fd\u5185\u7f51\u7edc\u73af\u5883\u4e0b\u4f1a\u9047\u5230\u4e00\u4e2a\u81f4\u547d\u7684\u95ee\u9898\uff1aUDP \u5c01\u9501/\u9650\u901f\u3002\u867d\u7136\u901a\u8fc7 WireGuard \u53ef\u4ee5\u5728\u96a7\u9053\u5185\u4f20\u8f93\u4efb\u4f55\u57fa\u4e8e IP \u7684\u534f\u8bae\uff08TCP\u3001UDP\u3001ICMP\u3001SCTP\u3001IPIP\u3001GRE \u7b49\uff09\uff0c\u4f46 WireGuard \u96a7\u9053\u672c\u8eab\u662f\u901a\u8fc7 UDP \u534f\u8bae\u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u800c\u56fd\u5185\u8fd0\u8425\u5546\u51e0\u4e4e\u5168\u90e8\u91c7\u53d6\u4e00\u5200\u5207\u7684\u624b\u6bb5\uff1a\u5bf9 UDP \u8fdb\u884c\u9650\u901f\u751a\u81f3\u5c01\u9501\u3002\\n\\n\\n\\n\u89e3\u51b3\u65b9\u6cd5\uff1a\u4f7f\u7528[Phantun](https://github.com/dndx/phantun)\u5c06UDP\u4f2a\u88c5\u6210TCP\u8fde\u63a5\u3002\\n\\n\\n\\n##### \u670d\u52a1\u7aef\uff1a\\n\\n\u5047\u8bbe\u670d\u52a1\u7aef\u7684\u516c\u7f51 IP \u5730\u5740\u662f `121.36.134.95`\uff0cWireGuard \u76d1\u542c\u7aef\u53e3\u662f `51822`\u3002\u9996\u5148\u4fee\u6539\u914d\u7f6e\u6587\u4ef6 `/etc/wireguard/wg0.conf`\uff0c\u5728 `[Interface]` \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\\n\\n> \u5982\u679c\u4f60\u4f7f\u7528 ping \u6216\u8005 dig \u7b49\u5de5\u5177\uff08\u5c0f\u6570\u636e\u5305\uff09\u6d4b\u8bd5 WireGuard \u96a7\u9053\u80fd\u591f\u6b63\u5e38\u5de5\u4f5c\uff0c\u4f46\u6d4f\u89c8\u5668\u6216\u8005\u8fdc\u7a0b\u684c\u9762\uff08\u5927\u6570\u636e\u5305\uff09\u5374\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\uff0c\u5f88\u6709\u53ef\u80fd\u662f MTU \u7684\u95ee\u9898\uff0c\u4f60\u9700\u8981\u5c06 MTU \u7684\u503c\u8c03\u5c0f\u4e00\u70b9\u3002\\n>\\n> Phantun \u5b98\u65b9\u5efa\u8bae\u5c06 MTU \u7684\u503c\u8bbe\u4e3a `1428`\uff08\u5047\u8bbe\u7269\u7406\u7f51\u5361\u7684 MTU \u662f 1500\uff09\uff0c\u4f46\u7ecf\u6211\u6d4b\u8bd5\u662f\u6709\u95ee\u9898\u7684\u3002\u5efa\u8bae\u76f4\u63a5\u5c06 MTU \u8bbe\u7f6e\u4e3a\u6700\u4f4e\u503c `1280`\uff0c\u7136\u540e\u6e10\u6e10\u589e\u52a0\uff0c\u76f4\u5230\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\u4e3a\u6b62\uff0c\u6b64\u65f6\u4f60\u7684 MTU \u5c31\u662f\u6700\u4f73\u503c\u3002\\n\\n```ini\\nMTU = 1300\\nPreUp = iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 4567 -j DNAT --to-destination 192.168.201.2\\nPreUp = RUST_LOG=info phantun_server --local 4567 --remote 127.0.0.1:51822 &> /var/log/phantun_server.log &\\nPostDown = iptables -t nat -D PREROUTING -p tcp -i eth0 --dport 4567 -j DNAT --to-destination 192.168.201.2\\nPostDown = killall phantun_server || true\\n```\\n\\n\\n\\n\u4f60\u9700\u8981\u5c06 eth0 \u66ff\u6362\u4e3a\u4f60\u670d\u52a1\u7aef\u7684\u7269\u7406\u7f51\u5361\u540d\u3002MTU \u503c\u5148\u4e0d\u7ba1\uff0c\u540e\u9762\u518d\u544a\u8bc9\u5927\u5bb6\u8c03\u8bd5\u65b9\u6cd5\u3002\\n\\n```ini\\nPreUp = iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 4567 -j DNAT --to-destination 192.168.201.2\\n```\\n\\n\\n\\n\u8fd9\u6761 iptables \u89c4\u5219\u8868\u793a\u5c06 `4567` \u7aef\u53e3\u7684\u5165\u7ad9\u6d41\u91cf DNAT \u4e3a TUN \u7f51\u5361\u7684 IP \u5730\u5740\u3002\\n\\n```ini\\nPreUp = RUST_LOG=info phantun_server --local 4567 --remote 127.0.0.1:51822 &> /var/log/phantun_server.log &\\n```\\n\\n\\n\\n\u8fd9\u91cc\u4f1a\u542f\u52a8 phantun_server\uff0c\u76d1\u542c\u5728 `4567` \u7aef\u53e3\uff0c\u5e76\u5c06 UDP \u6570\u636e\u5305\u8f6c\u53d1\u5230 WireGuard\u3002\\n\\n\u670d\u52a1\u7aef\u5b8c\u6574\u7684 WireGuard \u914d\u7f6e\uff1a\\n\\n```ini\\n# local settings for Endpoint B\\n[Interface]\\nPrivateKey = QH1BJzIZcGo89ZTykxls4i2DKgvByUkHIBy3BES2gX8= \\nAddress = 10.0.0.2/32\\nListenPort = 51822\\nMTU = 1300\\nPreUp = iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 4567 -j DNAT --to-destination 192.168.201.2\\nPreUp = RUST_LOG=info phantun_server --local 4567 --remote 127.0.0.1:51822 &> /var/log/phantun_server.log &\\nPostDown = iptables -t nat -D PREROUTING -p tcp -i eth0 --dport 4567 -j DNAT --to-destination 192.168.201.2\\nPostDown = killall phantun_server || true\\n\\n# remote settings for Endpoint A\\n[Peer]\\nPublicKey = wXtD/VrRo92JHc66q4Ypmnd4JpMk7b1Sb0AcT+pJfwY= \\nAllowedIPs = 10.0.0.1/32\\n```\\n\\n\\n\\n\u6700\u540e\u91cd\u542f WireGuard \u5373\u53ef\uff1a\\n\\n```bash\\n$ systemctl restart wg-quick@wg0\\n```\\n\\n\\n\\n\\n\\n##### \u5ba2\u6237\u7aef\uff1a\\n\\n\u5047\u8bbe\u5ba2\u6237\u7aef\u7684 WireGuard \u76d1\u542c\u7aef\u53e3\u662f `51821`\u3002\u9996\u5148\u4fee\u6539\u914d\u7f6e\u6587\u4ef6 `/etc/wireguard/wg0.conf`\uff0c\u5728 `[Interface]` \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff1a\\n\\n```ini\\nMTU = 1300\\nPreUp = iptables -t nat -A POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\nPreUp = RUST_LOG=info phantun_client --local 127.0.0.1:4567 --remote 121.36.134.95:4567 &> /var/log/phantun_client.log &\\nPostDown = iptables -t nat -D POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\nPostDown = killall phantun_client || true\\n```\\n\\n\\n\\n\u4f60\u9700\u8981\u5c06 eth0 \u66ff\u6362\u4e3a\u4f60\u670d\u52a1\u7aef\u7684\u7269\u7406\u7f51\u5361\u540d\u3002\\n\\n```ini\\nPreUp = iptables -t nat -A POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\n```\\n\\n\\n\\n\u8fd9\u6761 iptables \u89c4\u5219\u8868\u793a\u5bf9\u6765\u81ea `192.168.200.2`\uff08TUN \u7f51\u5361\uff09 \u7684\u51fa\u7ad9\u6d41\u91cf\u8fdb\u884c MASQUERADE\u3002\\n\\n```ini\\nPreUp = RUST_LOG=info phantun_client --local 127.0.0.1:4567 --remote 121.36.134.95:4567 &> /var/log/phantun_client.log &\\n```\\n\\n\\n\\n\u8fd9\u91cc\u4f1a\u542f\u52a8 phantun_client\uff0c\u76d1\u542c\u5728 `4567` \u7aef\u53e3\uff0c\u5e76\u4e0e\u670d\u52a1\u7aef\u5efa\u7acb\u8fde\u63a5\uff0c\u5c06\u4f2a\u88c5\u7684 TCP \u6570\u636e\u5305\u4f20\u9001\u7ed9\u670d\u52a1\u7aef\u3002\\n\\n\u9664\u6b64\u4e4b\u5916\u8fd8\u9700\u8981\u4fee\u6539 WireGuard peer \u7684 Endpoint\uff0c\u5c06\u5176\u4fee\u6539\u4e3a 127.0.0.1:4567\u3002\\n\\n```ini\\nEndpoint = 127.0.0.1:4567\\n```\\n\\n\\n\\n\u5ba2\u6237\u7aef\u5b8c\u6574\u7684 WireGuard \u914d\u7f6e\uff1a\\n\\n```ini\\n# local settings for Endpoint A\\n[Interface]\\nPrivateKey = 0Pyz3cIg2gRt+KxZ0Vm1PvSIU+0FGufPIzv92jTyGWk=\\nAddress = 10.0.0.1/32\\nListenPort = 51821\\nMTU = 1300\\nPreUp = iptables -t nat -A POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\nPreUp = RUST_LOG=info phantun_client --local 127.0.0.1:4567 --remote 121.36.134.95:4567 &> /var/log/phantun_client.log &\\nPostDown = iptables -t nat -D POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\nPostDown = killall phantun_client || true\\n\\n# remote settings for Endpoint B\\n[Peer]\\nPublicKey = m40NDb5Cqtb78b1DVwY1+kxbG2yEcRhxlrLm/DlPpz8=\\nEndpoint = 127.0.0.1:4567\\nAllowedIPs = 10.0.0.2/32\\nPersistentKeepalive = 25\\n```\\n\\n\\n\\n\u6700\u540e\u91cd\u542f WireGuard \u5373\u53ef\uff1a\\n\\n```bash\\n$ systemctl restart wg-quick@wg0\\n```\\n\\n\\n\\n##### \u5ba2\u6237\u7aef\uff08\u591a\u670d\u52a1\u7aef\uff09\uff1a\\n\\n\u5982\u679c\u5ba2\u6237\u7aef\u60f3\u548c\u591a\u4e2a\u670d\u52a1\u7aef\u5efa\u7acb\u8fde\u63a5\uff0c\u5219\u65b0\u589e\u7684\u670d\u52a1\u7aef\u914d\u7f6e\u5982\u4e0b\uff1a\\n\\n```ini\\nPreUp = RUST_LOG=info phantun_client --local 127.0.0.1:4568 --remote xxxx:4567 --tun-local=192.168.202.1 --tun-peer=192.168.202.2 &> /var/log/phantun_client.log &\\nPostDown = iptables -t nat -D POSTROUTING -o eth0 -s 192.168.202.2 -j MASQUERADE\\n```\\n\\n\\n\\n\u672c\u5730\u76d1\u542c\u7aef\u53e3\u9700\u8981\u9009\u62e9\u4e00\u4e2a\u4e0e\u4e4b\u524d\u4e0d\u540c\u7684\u7aef\u53e3\uff0c\u540c\u7406\uff0cTUN \u7f51\u5361\u7684\u5730\u5740\u4e5f\u9700\u8981\u4fee\u6539\u3002\u6700\u7ec8\u7684\u914d\u7f6e\u5982\u4e0b\uff1a\\n\\n```ini\\n# local settings for Endpoint A\\n[Interface]\\nPrivateKey = 0Pyz3cIg2gRt+KxZ0Vm1PvSIU+0FGufPIzv92jTyGWk=\\nAddress = 10.0.0.1/32\\nListenPort = 51821\\nMTU = 1300\\nPreUp = iptables -t nat -A POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\nPreUp = RUST_LOG=info phantun_client --local 127.0.0.1:4567 --remote 121.36.134.95:4567 &> /var/log/phantun_client.log &\\nPreUp = RUST_LOG=info phantun_client --local 127.0.0.1:4568 --remote xxxx:4567 --tun-local=192.168.202.1 --tun-peer=192.168.202.2 &> /var/log/phantun_client.log &\\nPostDown = iptables -t nat -D POSTROUTING -o eth0 -s 192.168.200.2 -j MASQUERADE\\nPostDown = iptables -t nat -D POSTROUTING -o eth0 -s 192.168.202.2 -j MASQUERADE\\nPostDown = killall phantun_client || true\\n\\n# remote settings for Endpoint B\\n[Peer]\\nPublicKey = m40NDb5Cqtb78b1DVwY1+kxbG2yEcRhxlrLm/DlPpz8=\\nEndpoint = 127.0.0.1:4567\\nAllowedIPs = 10.0.0.2/32\\nPersistentKeepalive = 25\\n```"}]}')}}]);